<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retirement Projector</title>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Shared Dashboard Libraries -->
    <script src="constants.js"></script>
    <script src="state-manager.js"></script>
    <style>
        :root {
            --brand-navy: #00205B;
            --brand-navy-light: #003380;
            --brand-gold: #D4AF37;
            --brand-gold-hover: #B5952F;
            --brand-light: #F9F9F7;
            --brand-white: #FFFFFF;
            --text-primary: #1a1a2e;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border: #E2E8F0;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--brand-light);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 4px solid var(--brand-gold);
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--brand-navy);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 4px;
            background: var(--brand-white);
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 24px;
            border: 2px solid var(--border);
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--brand-navy);
            color: var(--brand-white);
        }

        .tab:hover:not(.active) {
            background: var(--brand-light);
            color: var(--brand-navy);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        @media (max-width: 1200px) {

            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 900px) {
            .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .card {
            background: var(--brand-white);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 32, 91, 0.06);
        }

        .card-header {
            background: var(--brand-navy);
            padding: 14px 20px;
        }

        .card-header h2 {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--brand-white);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-header .icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--brand-gold);
        }

        .card-body {
            padding: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--brand-navy);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .form-group input,
        .form-group select {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: var(--brand-white);
            color: var(--text-primary);
            width: 100%;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--brand-gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
        }

        .input-prefix {
            position: relative;
        }

        .input-prefix span {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .input-prefix input {
            padding-left: 24px;
        }

        .input-suffix {
            position: relative;
        }

        .input-suffix span {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .input-suffix input {
            padding-right: 30px;
        }

        .stat-card {
            background: var(--brand-light);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .stat-card.primary {
            background: var(--brand-navy);
            border-color: var(--brand-gold);
        }

        .stat-card.success {
            border-color: var(--success);
            background: #ecfdf5;
        }

        .stat-card.warning {
            border-color: var(--warning);
            background: #fffbeb;
        }

        .stat-card.danger {
            border-color: var(--danger);
            background: #fef2f2;
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .stat-card.primary .stat-label {
            color: var(--brand-gold);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--brand-navy);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-card.primary .stat-value {
            color: var(--brand-white);
        }

        .stat-card.success .stat-value {
            color: var(--success);
        }

        .stat-card.warning .stat-value {
            color: var(--warning);
        }

        .stat-card.danger .stat-value {
            color: var(--danger);
        }

        .stat-sub {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .stat-card.primary .stat-sub {
            color: rgba(255, 255, 255, 0.7);
        }

        .gauge-container {
            position: relative;
            width: 200px;
            height: 120px;
            margin: 0 auto;
        }

        .gauge-bg {
            fill: none;
            stroke: var(--border);
            stroke-width: 20;
        }

        .gauge-fill {
            fill: none;
            stroke-width: 20;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .gauge-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 32px;
            font-weight: 700;
            fill: var(--brand-navy);
        }

        .gauge-label {
            font-size: 12px;
            fill: var(--text-muted);
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        .chart-container.tall {
            height: 400px;
        }

        .slider-group {
            margin-bottom: 20px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .slider-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--brand-navy);
            text-transform: uppercase;
        }

        .slider-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            color: var(--brand-gold);
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--border);
            appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--brand-gold);
            border: 3px solid var(--brand-white);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .monte-carlo-results {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .mc-result {
            text-align: center;
            padding: 12px;
            background: var(--brand-light);
            border-radius: 8px;
        }

        .mc-percentile {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
        }

        .mc-value {
            font-size: 16px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--brand-navy);
            margin-top: 4px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--brand-gold);
            color: var(--brand-navy);
        }

        .btn-primary:hover {
            background: var(--brand-gold-hover);
        }

        .year-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .year-table th {
            background: var(--brand-navy);
            color: white;
            padding: 10px 8px;
            text-align: right;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .year-table th:first-child {
            text-align: left;
        }

        .year-table td {
            padding: 8px;
            text-align: right;
            border-bottom: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
        }

        .year-table td:first-child {
            text-align: left;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
        }

        .year-table tr:nth-child(even) {
            background: var(--brand-light);
        }

        .year-table .negative {
            color: var(--danger);
        }

        .year-table .positive {
            color: var(--success);
        }

        .table-scroll {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .alert-warning {
            background: #fffbeb;
            border: 1px solid var(--warning);
            color: #92400e;
        }

        .alert-danger {
            background: #fef2f2;
            border: 1px solid var(--danger);
            color: #991b1b;
        }

        .alert-icon {
            font-size: 18px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .alert-text {
            font-size: 13px;
            opacity: 0.9;
        }

        .scenario-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .scenario-btn {
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: var(--brand-white);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scenario-btn.active {
            background: var(--brand-navy);
            color: white;
            border-color: var(--brand-navy);
        }

        .scenario-btn:hover:not(.active) {
            border-color: var(--brand-gold);
        }

        @media (max-width: 768px) {
            .monte-carlo-results {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24"
                    stroke-width="1.5" stroke="#D4AF37">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Retirement Projector
            </h1>
            <p class="subtitle">Monte Carlo simulation • Year-by-year cash flow • Tax-efficient withdrawal sequencing
            </p>
        </header>

        <div class="tabs" id="tabBar">
            <button class="tab active" data-tab="dashboard">Dashboard</button>
            <button class="tab" data-tab="inputs">Client Inputs</button>
            <button class="tab" data-tab="income">Income Sources</button>
            <button class="tab" data-tab="projection">Year-by-Year</button>
            <button class="tab" data-tab="montecarlo">Monte Carlo</button>
            <button class="tab" data-tab="scenarios">Scenarios</button>
        </div>

        <!-- DASHBOARD TAB -->
        <div id="tab-dashboard" class="tab-content active">
            <div id="alertArea"></div>
            <div class="grid-4">
                <div class="stat-card primary">
                    <div class="stat-label">Success Probability</div>
                    <div class="stat-value" id="successRate">--%</div>
                    <div class="stat-sub">Monte Carlo (1,000 runs)</div>
                </div>
                <div class="stat-card" id="legacyCard">
                    <div class="stat-label">Projected Legacy (Age 95)</div>
                    <div class="stat-value" id="legacyValue">$0</div>
                    <div class="stat-sub">Median outcome</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Sustainable Withdrawal</div>
                    <div class="stat-value" id="safeWithdrawal">0%</div>
                    <div class="stat-sub">Inflation-adjusted</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Income Floor Coverage</div>
                    <div class="stat-value" id="floorCoverage">0%</div>
                    <div class="stat-sub">SS + Pensions vs Essential</div>
                </div>
            </div>
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon"></span>Success Probability Gauge</h2>
                    </div>
                    <div class="card-body" style="text-align:center;">
                        <div class="gauge-container">
                            <svg viewBox="0 0 200 120" width="200" height="120">
                                <path class="gauge-bg" d="M 20 100 A 80 80 0 0 1 180 100" />
                                <path class="gauge-fill" id="gaugeFill" d="M 20 100 A 80 80 0 0 1 180 100"
                                    stroke="#10b981" style="stroke-dasharray: 251; stroke-dashoffset: 251;" />
                                <text x="100" y="90" text-anchor="middle" class="gauge-text" id="gaugeText">--%</text>
                                <text x="100" y="110" text-anchor="middle" class="gauge-label">Success Rate</text>
                            </svg>
                        </div>
                        <div
                            style="display:flex;justify-content:space-between;margin-top:12px;font-size:11px;color:var(--text-muted);">
                            <span>0%</span>
                            <span style="color:var(--danger);">High Risk</span>
                            <span style="color:var(--warning);">Caution</span>
                            <span style="color:var(--success);">On Track</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon"></span>Portfolio Balance Projection</h2>
                    </div>
                    <div class="card-body">
                        <div class="chart-container"><canvas id="balanceChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- INPUTS TAB -->
        <div id="tab-inputs" class="tab-content">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon"></span>Client 1 Information</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group"><label>Current Age</label><input type="number" id="client1Age"
                                    value="60"></div>
                            <div class="form-group"><label>Retirement Age</label><input type="number"
                                    id="client1RetireAge" value="65"></div>
                            <div class="form-group"><label>Life Expectancy</label><input type="number"
                                    id="client1LifeExp" value="95"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Current Salary</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="client1Salary"
                                        value="150000"></div>
                            </div>
                            <div class="form-group"><label>Annual Raise %</label>
                                <div class="input-suffix"><span>%</span><input type="number" id="client1Raise" value="2"
                                        step="0.5"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon"></span>Client 2 (Spouse)</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-group" style="margin-bottom:16px;"><label><input type="checkbox" id="hasSpouse"
                                    checked> Include Spouse</label></div>
                        <div id="spouseInputs">
                            <div class="form-row">
                                <div class="form-group"><label>Current Age</label><input type="number" id="client2Age"
                                        value="58"></div>
                                <div class="form-group"><label>Retirement Age</label><input type="number"
                                        id="client2RetireAge" value="65"></div>
                                <div class="form-group"><label>Life Expectancy</label><input type="number"
                                        id="client2LifeExp" value="95"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group"><label>Current Salary</label>
                                    <div class="input-prefix"><span>$</span><input type="number" id="client2Salary"
                                            value="80000"></div>
                                </div>
                                <div class="form-group"><label>Annual Raise %</label>
                                    <div class="input-suffix"><span>%</span><input type="number" id="client2Raise"
                                            value="2" step="0.5"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon"></span>Current Portfolio</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group"><label>Pre-Tax (401k/IRA)</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="preTaxBalance"
                                        value="800000"></div>
                            </div>
                            <div class="form-group"><label>Roth (IRA/401k)</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="rothBalance"
                                        value="200000"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Taxable Brokerage</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="taxableBalance"
                                        value="300000"></div>
                            </div>
                            <div class="form-group"><label>Cash/Savings</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="cashBalance"
                                        value="50000"></div>
                            </div>
                        </div>
                        <div style="background:var(--brand-light);padding:12px;border-radius:8px;margin-top:12px;">
                            <div style="display:flex;justify-content:space-between;"><span
                                    style="font-size:12px;color:var(--text-muted);">Total Portfolio</span><span
                                    style="font-size:16px;font-weight:700;color:var(--brand-navy);font-family:'JetBrains Mono';"
                                    id="totalPortfolio">$1,350,000</span></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon"></span>Annual Savings</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group"><label>401(k) Contrib (Both)</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="contrib401k"
                                        value="49000"></div>
                            </div>
                            <div class="form-group"><label>Employer Match</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="employerMatch"
                                        value="15000"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Roth IRA (Both)</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="contribRothIRA"
                                        value="15000"></div>
                            </div>
                            <div class="form-group"><label>Taxable Savings</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="contribTaxable"
                                        value="20000"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon"></span>Spending Requirements</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group"><label>Essential Expenses</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="essentialExpenses"
                                        value="60000"></div>
                            </div>
                            <div class="form-group"><label>Discretionary</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="discretionaryExpenses"
                                        value="30000"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Healthcare (Pre-Medicare)</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="healthcarePre"
                                        value="18000"></div>
                            </div>
                            <div class="form-group"><label>Healthcare (Post-Medicare)</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="healthcarePost"
                                        value="8000"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon"></span>Assumptions</h2>
                    </div>
                    <div class="card-body">
                        <div class="slider-group">
                            <div class="slider-header"><span class="slider-label">Inflation Rate</span><span
                                    class="slider-value" id="inflationDisplay">2.5%</span></div><input type="range"
                                id="inflation" min="1" max="5" step="0.1" value="2.5">
                        </div>
                        <div class="slider-group">
                            <div class="slider-header"><span class="slider-label">Pre-Retirement Return</span><span
                                    class="slider-value" id="preReturnDisplay">7.0%</span></div><input type="range"
                                id="preReturn" min="3" max="10" step="0.5" value="7">
                        </div>
                        <div class="slider-group">
                            <div class="slider-header"><span class="slider-label">Retirement Return</span><span
                                    class="slider-value" id="retReturnDisplay">5.5%</span></div><input type="range"
                                id="retReturn" min="2" max="8" step="0.5" value="5.5">
                        </div>
                        <div class="slider-group">
                            <div class="slider-header"><span class="slider-label">Volatility (Std Dev)</span><span
                                    class="slider-value" id="volatilityDisplay">12%</span></div><input type="range"
                                id="volatility" min="5" max="25" step="1" value="12">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- INCOME TAB -->
        <div id="tab-income" class="tab-content">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon"></span>Social Security - Client 1</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group"><label>FRA Benefit (Monthly)</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="ss1FRA" value="3200">
                                </div>
                            </div>
                            <div class="form-group"><label>Claiming Age</label><select id="ss1Age">
                                    <option value="62">62 (70%)</option>
                                    <option value="63">63 (75%)</option>
                                    <option value="64">64 (80%)</option>
                                    <option value="65">65 (86.7%)</option>
                                    <option value="66">66 (93.3%)</option>
                                    <option value="67" selected>67 (100%)</option>
                                    <option value="68">68 (108%)</option>
                                    <option value="69">69 (116%)</option>
                                    <option value="70">70 (124%)</option>
                                </select></div>
                        </div>
                        <div style="background:var(--brand-light);padding:12px;border-radius:8px;margin-top:8px;">
                            <div style="display:flex;justify-content:space-between;"><span
                                    style="font-size:12px;color:var(--text-muted);">Annual Amount</span><span
                                    style="font-size:16px;font-weight:700;color:var(--success);font-family:'JetBrains Mono';"
                                    id="ss1Annual">$38,400</span></div>
                        </div>
                    </div>
                </div>
                <div class="card" id="ss2Card">
                    <div class="card-header">
                        <h2><span class="icon"></span>Social Security - Client 2</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group"><label>FRA Benefit (Monthly)</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="ss2FRA" value="2400">
                                </div>
                            </div>
                            <div class="form-group"><label>Claiming Age</label><select id="ss2Age">
                                    <option value="62">62 (70%)</option>
                                    <option value="63">63 (75%)</option>
                                    <option value="64">64 (80%)</option>
                                    <option value="65">65 (86.7%)</option>
                                    <option value="66">66 (93.3%)</option>
                                    <option value="67" selected>67 (100%)</option>
                                    <option value="68">68 (108%)</option>
                                    <option value="69">69 (116%)</option>
                                    <option value="70">70 (124%)</option>
                                </select></div>
                        </div>
                        <div style="background:var(--brand-light);padding:12px;border-radius:8px;margin-top:8px;">
                            <div style="display:flex;justify-content:space-between;"><span
                                    style="font-size:12px;color:var(--text-muted);">Annual Amount</span><span
                                    style="font-size:16px;font-weight:700;color:var(--success);font-family:'JetBrains Mono';"
                                    id="ss2Annual">$28,800</span></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon"></span>Pensions</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-row" style="align-items:end;">
                            <div class="form-group"><label>Pension Name</label><input type="text" id="pension1Name"
                                    value="" placeholder="e.g., Company Pension"></div>
                            <div class="form-group"><label>Annual Amount</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="pension1Amount"
                                        value="0"></div>
                            </div>
                            <div class="form-group"><label>Start Age</label><input type="number" id="pension1StartAge"
                                    value="65"></div>
                            <div class="form-group"><label>COLA %</label>
                                <div class="input-suffix"><span>%</span><input type="number" id="pension1COLA" value="0"
                                        step="0.5"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon"></span>Other Income</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group"><label>Rental Income (Annual)</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="rentalIncome"
                                        value="0"></div>
                            </div>
                            <div class="form-group"><label>Part-Time Work</label>
                                <div class="input-prefix"><span>$</span><input type="number" id="partTimeIncome"
                                        value="0"></div>
                            </div>
                            <div class="form-group"><label>Part-Time Until Age</label><input type="number"
                                    id="partTimeUntilAge" value="70"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h2><span class="icon"></span>Income Timeline</h2>
                </div>
                <div class="card-body">
                    <div class="chart-container"><canvas id="incomeChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- PROJECTION TAB -->
        <div id="tab-projection" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2><span class="icon"></span>Year-by-Year Projection</h2>
                </div>
                <div class="card-body">
                    <div class="table-scroll">
                        <table class="year-table">
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>Age</th>
                                    <th>Earnings</th>
                                    <th>SS Income</th>
                                    <th>Pension</th>
                                    <th>Total Income</th>
                                    <th>Spending</th>
                                    <th>Taxes</th>
                                    <th>Net Flow</th>
                                    <th>Portfolio</th>
                                </tr>
                            </thead>
                            <tbody id="projectionTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- MONTE CARLO TAB -->
        <div id="tab-montecarlo" class="tab-content">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon"></span>Monte Carlo Settings</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group"><label>Number of Simulations</label><select id="mcSimulations">
                                    <option value="500">500 (Fast)</option>
                                    <option value="1000" selected>1,000</option>
                                    <option value="2500">2,500</option>
                                </select></div>
                            <div class="form-group"><label>Include Sequence Risk</label><select id="mcSequence">
                                    <option value="yes" selected>Yes</option>
                                    <option value="no">No</option>
                                </select></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Bear Market Stress Test</label><select id="mcBearMarket">
                                    <option value="none" selected>None</option>
                                    <option value="year1">-20% Year 1</option>
                                    <option value="year12">-20% Years 1-2</option>
                                    <option value="year123">-30% Years 1-3</option>
                                </select></div>
                            <div class="form-group"><label>Inflation Spike</label><select id="mcInflationSpike">
                                    <option value="none" selected>None</option>
                                    <option value="moderate">+2% for 3 years</option>
                                    <option value="severe">+4% for 5 years</option>
                                </select></div>
                        </div>
                        <button class="btn btn-primary" id="runMCBtn" style="width:100%;margin-top:12px;">Run Monte
                            Carlo Simulation</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon"></span>Simulation Results</h2>
                    </div>
                    <div class="card-body" style="text-align:center;">
                        <div style="font-size:14px;color:var(--text-muted);margin-bottom:8px;">Probability of Success
                        </div>
                        <div style="font-size:64px;font-weight:700;font-family:'JetBrains Mono';" id="mcSuccessRate">--%
                        </div>
                        <div style="font-size:12px;color:var(--text-muted);">maintain portfolio through age <span
                                id="mcEndAge">95</span></div>
                        <div class="monte-carlo-results">
                            <div class="mc-result">
                                <div class="mc-percentile">5th %ile</div>
                                <div class="mc-value" id="mc5">--</div>
                            </div>
                            <div class="mc-result">
                                <div class="mc-percentile">25th %ile</div>
                                <div class="mc-value" id="mc25">--</div>
                            </div>
                            <div class="mc-result" style="background:var(--brand-navy);border-radius:8px;">
                                <div class="mc-percentile" style="color:var(--brand-gold);">Median</div>
                                <div class="mc-value" style="color:white;" id="mc50">--</div>
                            </div>
                            <div class="mc-result">
                                <div class="mc-percentile">75th %ile</div>
                                <div class="mc-value" id="mc75">--</div>
                            </div>
                            <div class="mc-result">
                                <div class="mc-percentile">95th %ile</div>
                                <div class="mc-value" id="mc95">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h2><span class="icon"></span>Portfolio Projection Fan Chart</h2>
                </div>
                <div class="card-body">
                    <div class="chart-container tall"><canvas id="mcChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- SCENARIOS TAB -->
        <div id="tab-scenarios" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2><span class="icon"></span>Scenario Comparison</h2>
                </div>
                <div class="card-body">
                    <div class="scenario-toggle">
                        <button class="scenario-btn active" data-scenario="base">Base Case</button>
                        <button class="scenario-btn" data-scenario="earlyRetire">Early Retirement (62)</button>
                        <button class="scenario-btn" data-scenario="delayedSS">Delayed SS (70)</button>
                        <button class="scenario-btn" data-scenario="reducedSpend">Reduced Spending (-15%)</button>
                        <button class="scenario-btn" data-scenario="marketCrash">Market Crash Year 1</button>
                    </div>
                </div>
            </div>
            <div class="grid-3">
                <div class="stat-card">
                    <div class="stat-label">Success Probability</div>
                    <div class="stat-value" id="scenarioSuccess">--%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Median Legacy</div>
                    <div class="stat-value" id="scenarioLegacy">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Safe Withdrawal</div>
                    <div class="stat-value" id="scenarioWithdrawal">0%</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h2><span class="icon"></span>Scenario Portfolio Projection</h2>
                </div>
                <div class="card-body">
                    <div class="chart-container tall"><canvas id="scenarioChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Utility functions
        const fC = n => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(n || 0);
        const fP = n => (n * 100).toFixed(1) + '%';
        const getVal = id => parseFloat(document.getElementById(id).value) || 0;

        // Chart instances
        let balanceChart, incomeChart, mcChart, scenarioChart;

        // Data storage
        let projectionData = [];
        let mcResults = { success: 0, percentiles: {}, paths: [] };

        // SS adjustment factors
        const ssFactors = { 62: 0.70, 63: 0.75, 64: 0.80, 65: 0.867, 66: 0.933, 67: 1.00, 68: 1.08, 69: 1.16, 70: 1.24 };

        // 2026 Tax brackets (MFJ) - per RBC Key Numbers 2026
        const taxBrackets = [
            { min: 0, max: 24800, rate: 0.10 }, { min: 24800, max: 100800, rate: 0.12 },
            { min: 100800, max: 211400, rate: 0.22 }, { min: 211400, max: 403550, rate: 0.24 },
            { min: 403550, max: 512450, rate: 0.32 }, { min: 512450, max: 768700, rate: 0.35 },
            { min: 768700, max: Infinity, rate: 0.37 }
        ];
        const stdDeduction = 32200;

        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            if (btn) btn.classList.add('active');
            setTimeout(() => {
                if (tabId === 'dashboard') renderBalanceChart();
                if (tabId === 'income') renderIncomeChart();
                if (tabId === 'montecarlo') renderMCChart();
                if (tabId === 'scenarios') renderScenarioChart();
            }, 50);
        }

        function toggleSpouse() {
            const show = document.getElementById('hasSpouse').checked;
            document.getElementById('spouseInputs').style.display = show ? 'block' : 'none';
            document.getElementById('ss2Card').style.display = show ? 'block' : 'none';
        }

        function calcTax(income) {
            const taxable = Math.max(0, income - stdDeduction);
            let tax = 0, remaining = taxable;
            for (const b of taxBrackets) {
                const inBracket = Math.min(remaining, b.max - b.min);
                tax += inBracket * b.rate;
                remaining -= inBracket;
                if (remaining <= 0) break;
            }
            return tax;
        }

        function runProjection(overrides) {
            overrides = overrides || {};
            const currentYear = 2026;
            const hasSpouse = document.getElementById('hasSpouse').checked;

            let c1Age = overrides.c1Age || getVal('client1Age');
            let c1RetireAge = overrides.c1RetireAge || getVal('client1RetireAge');
            let c1LifeExp = overrides.c1LifeExp || getVal('client1LifeExp');
            let c2Age = hasSpouse ? getVal('client2Age') : 0;
            let c2RetireAge = hasSpouse ? getVal('client2RetireAge') : 0;

            const yearsToProject = c1LifeExp - c1Age;

            let preTax = getVal('preTaxBalance');
            let roth = getVal('rothBalance');
            let taxable = getVal('taxableBalance');
            let cash = getVal('cashBalance');

            const contrib401k = getVal('contrib401k');
            const employerMatch = getVal('employerMatch');
            const contribRoth = getVal('contribRothIRA');
            const contribTaxable = getVal('contribTaxable');

            let essential = overrides.essential || getVal('essentialExpenses');
            let discretionary = overrides.discretionary || getVal('discretionaryExpenses');
            const healthcarePre = getVal('healthcarePre');
            const healthcarePost = getVal('healthcarePost');

            const ss1FRA = getVal('ss1FRA');
            const ss1ClaimAge = overrides.ss1Age || parseInt(document.getElementById('ss1Age').value);
            const ss1Annual = ss1FRA * ssFactors[ss1ClaimAge] * 12;

            const ss2FRA = hasSpouse ? getVal('ss2FRA') : 0;
            const ss2ClaimAge = hasSpouse ? (overrides.ss2Age || parseInt(document.getElementById('ss2Age').value)) : 99;
            const ss2Annual = hasSpouse ? ss2FRA * ssFactors[ss2ClaimAge] * 12 : 0;

            const pension1Amt = getVal('pension1Amount');
            const pension1Start = getVal('pension1StartAge');
            const pension1COLA = getVal('pension1COLA') / 100;

            const rental = getVal('rentalIncome');
            const partTime = getVal('partTimeIncome');
            const partTimeUntil = getVal('partTimeUntilAge');

            const inflation = getVal('inflation') / 100;
            const preReturn = overrides.preReturn !== undefined ? overrides.preReturn : getVal('preReturn') / 100;
            const retReturn = overrides.retReturn !== undefined ? overrides.retReturn : getVal('retReturn') / 100;

            // Update SS displays
            document.getElementById('ss1Annual').textContent = fC(ss1Annual);
            if (hasSpouse) document.getElementById('ss2Annual').textContent = fC(ss2Annual);
            document.getElementById('totalPortfolio').textContent = fC(preTax + roth + taxable + cash);

            projectionData = [];

            for (let i = 0; i <= yearsToProject; i++) {
                const age1 = c1Age + i;
                const age2 = hasSpouse ? c2Age + i : 0;
                const isRetired1 = age1 >= c1RetireAge;
                const isRetired2 = hasSpouse ? age2 >= c2RetireAge : true;
                const bothRetired = isRetired1 && isRetired2;
                const medicare = age1 >= 65 && (!hasSpouse || age2 >= 65);

                let earnings = 0;
                if (!isRetired1) earnings += getVal('client1Salary') * Math.pow(1.02, i);
                if (hasSpouse && !isRetired2) earnings += getVal('client2Salary') * Math.pow(1.02, i);

                let ssIncome = 0;
                if (age1 >= ss1ClaimAge) ssIncome += ss1Annual * Math.pow(1.02, Math.max(0, age1 - ss1ClaimAge));
                if (hasSpouse && age2 >= ss2ClaimAge) ssIncome += ss2Annual * Math.pow(1.02, Math.max(0, age2 - ss2ClaimAge));

                let pensionIncome = 0;
                if (age1 >= pension1Start && pension1Amt > 0) {
                    pensionIncome = pension1Amt * Math.pow(1 + pension1COLA, Math.max(0, age1 - pension1Start));
                }

                let otherIncome = rental * Math.pow(1 + inflation, i);
                if (age1 < partTimeUntil) otherIncome += partTime;

                const totalIncome = earnings + ssIncome + pensionIncome + otherIncome;

                const healthcare = medicare ? healthcarePost : healthcarePre;
                let spending = (essential + discretionary + healthcare) * Math.pow(1 + inflation, i);

                const taxableIncome = earnings + ssIncome * 0.85 + pensionIncome + otherIncome;
                const taxes = calcTax(taxableIncome);

                const netFlow = totalIncome - spending - taxes;

                const returnRate = bothRetired ? retReturn : preReturn;

                if (netFlow < 0 && bothRetired) {
                    let needed = Math.abs(netFlow);
                    const fromTaxable = Math.min(taxable, needed);
                    taxable -= fromTaxable; needed -= fromTaxable;
                    const fromPreTax = Math.min(preTax, needed);
                    preTax -= fromPreTax; needed -= fromPreTax;
                    const fromRoth = Math.min(roth, needed);
                    roth -= fromRoth;
                } else if (!bothRetired) {
                    preTax += contrib401k + employerMatch;
                    roth += contribRoth;
                    taxable += contribTaxable;
                }

                preTax *= (1 + returnRate);
                roth *= (1 + returnRate);
                taxable *= (1 + returnRate);

                const totalPortfolio = Math.max(0, preTax + roth + taxable + cash);

                projectionData.push({
                    year: currentYear + i, age: age1, age2,
                    earnings, ssIncome, pensionIncome, otherIncome, totalIncome,
                    spending, taxes, netFlow, preTax, roth, taxable, totalPortfolio
                });

                if (totalPortfolio <= 0) break;
            }

            updateDashboard();
            renderProjectionTable();
            return projectionData;
        }

        function updateDashboard() {
            if (projectionData.length === 0) return;

            const finalData = projectionData[projectionData.length - 1];
            const retireIdx = projectionData.findIndex(d => d.age >= getVal('client1RetireAge'));
            const retireData = retireIdx >= 0 ? projectionData[retireIdx] : projectionData[0];

            const initialPortfolio = projectionData[0].totalPortfolio;
            const safeRate = initialPortfolio > 0 ? (retireData.spending / initialPortfolio) : 0;

            const ssTotal = retireData.ssIncome;
            const pensionTotal = retireData.pensionIncome;
            const guaranteed = ssTotal + pensionTotal;
            const essential = getVal('essentialExpenses');
            const floorCoverage = essential > 0 ? guaranteed / essential : 0;

            document.getElementById('legacyValue').textContent = fC(finalData.totalPortfolio);
            document.getElementById('safeWithdrawal').textContent = fP(safeRate);
            document.getElementById('floorCoverage').textContent = fP(Math.min(floorCoverage, 2));

            const legacyCard = document.getElementById('legacyCard');
            legacyCard.className = finalData.totalPortfolio > initialPortfolio ? 'stat-card success' :
                finalData.totalPortfolio > 0 ? 'stat-card' : 'stat-card danger';

            const alertArea = document.getElementById('alertArea');
            alertArea.innerHTML = '';

            if (floorCoverage < 0.7) {
                alertArea.innerHTML += '<div class="alert alert-warning"><span class="alert-icon">⚠️</span><div class="alert-content"><div class="alert-title">Income Floor Gap</div><div class="alert-text">SS + pensions cover only ' + fP(floorCoverage) + ' of essential expenses.</div></div></div>';
            }
            if (safeRate > 0.05) {
                alertArea.innerHTML += '<div class="alert alert-danger"><span class="alert-icon">🚨</span><div class="alert-content"><div class="alert-title">High Withdrawal Rate</div><div class="alert-text">Initial withdrawal rate of ' + fP(safeRate) + ' exceeds 5% guideline.</div></div></div>';
            }

            const deficitYear = projectionData.find(d => d.totalPortfolio <= 0);
            if (deficitYear) {
                alertArea.innerHTML += '<div class="alert alert-danger"><span class="alert-icon">🚨</span><div class="alert-content"><div class="alert-title">Portfolio Depletion</div><div class="alert-text">Portfolio projected to run out at age ' + deficitYear.age + '.</div></div></div>';
            }
        }

        function renderProjectionTable() {
            const tbody = document.getElementById('projectionTable');
            const hasSpouse = document.getElementById('hasSpouse').checked;

            tbody.innerHTML = projectionData.map(d => {
                const ageDisplay = hasSpouse ? d.age + '/' + d.age2 : d.age;
                return '<tr>' +
                    '<td>' + d.year + '</td>' +
                    '<td>' + ageDisplay + '</td>' +
                    '<td>' + fC(d.earnings) + '</td>' +
                    '<td>' + fC(d.ssIncome) + '</td>' +
                    '<td>' + fC(d.pensionIncome) + '</td>' +
                    '<td><strong>' + fC(d.totalIncome) + '</strong></td>' +
                    '<td class="negative">' + fC(d.spending) + '</td>' +
                    '<td class="negative">' + fC(d.taxes) + '</td>' +
                    '<td class="' + (d.netFlow >= 0 ? 'positive' : 'negative') + '">' + fC(d.netFlow) + '</td>' +
                    '<td><strong>' + fC(d.totalPortfolio) + '</strong></td>' +
                    '</tr>';
            }).join('');
        }

        function runMonteCarlo() {
            const numSims = parseInt(document.getElementById('mcSimulations').value);
            const useSequence = document.getElementById('mcSequence').value === 'yes';
            const bearMarket = document.getElementById('mcBearMarket').value;
            const inflationSpike = document.getElementById('mcInflationSpike').value;

            const meanReturn = getVal('retReturn') / 100;
            const volatility = getVal('volatility') / 100;
            const baseInflation = getVal('inflation') / 100;

            const results = [];
            let successes = 0;

            for (let sim = 0; sim < numSims; sim++) {
                let portfolio = getVal('preTaxBalance') + getVal('rothBalance') + getVal('taxableBalance');
                const years = getVal('client1LifeExp') - getVal('client1Age');
                const retireAge = getVal('client1RetireAge');
                const currentAge = getVal('client1Age');
                const hasSpouse = document.getElementById('hasSpouse').checked;

                let spending = getVal('essentialExpenses') + getVal('discretionaryExpenses') + getVal('healthcarePre');
                const ss1 = getVal('ss1FRA') * ssFactors[parseInt(document.getElementById('ss1Age').value)] * 12;
                const ss2 = hasSpouse ? getVal('ss2FRA') * ssFactors[parseInt(document.getElementById('ss2Age').value)] * 12 : 0;
                const ss1Age = parseInt(document.getElementById('ss1Age').value);
                const ss2Age = hasSpouse ? parseInt(document.getElementById('ss2Age').value) : 99;

                const yearlyBalances = [portfolio];
                let failed = false;
                const retireStartYear = retireAge - currentAge;

                for (let y = 0; y < years; y++) {
                    const age = currentAge + y;
                    const isRetired = age >= retireAge;
                    const yearsInRetirement = isRetired ? y - retireStartYear : -1;

                    // Apply bear market stress test
                    let annualReturn = meanReturn;
                    if (useSequence) {
                        const u1 = Math.random(), u2 = Math.random();
                        const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
                        annualReturn = meanReturn + z * volatility;
                    }

                    // Bear market override for early retirement years
                    if (isRetired && yearsInRetirement >= 0) {
                        if (bearMarket === 'year1' && yearsInRetirement === 0) {
                            annualReturn = -0.20;
                        } else if (bearMarket === 'year12' && yearsInRetirement <= 1) {
                            annualReturn = -0.20;
                        } else if (bearMarket === 'year123' && yearsInRetirement <= 2) {
                            annualReturn = -0.30;
                        }
                    }

                    // Calculate inflation with potential spike
                    let yearInflation = baseInflation;
                    if (isRetired && yearsInRetirement >= 0) {
                        if (inflationSpike === 'moderate' && yearsInRetirement < 3) {
                            yearInflation = baseInflation + 0.02;
                        } else if (inflationSpike === 'severe' && yearsInRetirement < 5) {
                            yearInflation = baseInflation + 0.04;
                        }
                    }

                    let income = 0;
                    if (age >= ss1Age) income += ss1;
                    if (age >= ss2Age) income += ss2;

                    spending *= (1 + yearInflation);

                    if (isRetired) {
                        const withdrawal = Math.max(0, spending - income);
                        portfolio -= withdrawal;
                    } else {
                        portfolio += getVal('contrib401k') + getVal('employerMatch') + getVal('contribRothIRA');
                    }

                    portfolio *= (1 + annualReturn);
                    yearlyBalances.push(Math.max(0, portfolio));

                    if (portfolio <= 0) { failed = true; break; }
                }

                if (!failed) successes++;
                results.push({ final: portfolio, path: yearlyBalances });
            }

            const finals = results.map(r => r.final).sort((a, b) => a - b);
            mcResults = {
                success: successes / numSims,
                percentiles: {
                    p5: finals[Math.floor(numSims * 0.05)],
                    p25: finals[Math.floor(numSims * 0.25)],
                    p50: finals[Math.floor(numSims * 0.50)],
                    p75: finals[Math.floor(numSims * 0.75)],
                    p95: finals[Math.floor(numSims * 0.95)]
                },
                paths: results.slice(0, 100).map(r => r.path)
            };

            const successPct = Math.round(mcResults.success * 100);
            document.getElementById('successRate').textContent = successPct + '%';
            document.getElementById('mcSuccessRate').textContent = successPct + '%';
            document.getElementById('mcEndAge').textContent = getVal('client1LifeExp');

            document.getElementById('mc5').textContent = fC(mcResults.percentiles.p5);
            document.getElementById('mc25').textContent = fC(mcResults.percentiles.p25);
            document.getElementById('mc50').textContent = fC(mcResults.percentiles.p50);
            document.getElementById('mc75').textContent = fC(mcResults.percentiles.p75);
            document.getElementById('mc95').textContent = fC(mcResults.percentiles.p95);

            document.getElementById('legacyValue').textContent = fC(mcResults.percentiles.p50);

            updateGauge(successPct);
            renderMCChart();

            document.getElementById('scenarioSuccess').textContent = successPct + '%';
            document.getElementById('scenarioLegacy').textContent = fC(mcResults.percentiles.p50);
            document.getElementById('scenarioWithdrawal').textContent = document.getElementById('safeWithdrawal').textContent;
        }

        function updateGauge(pct) {
            const gauge = document.getElementById('gaugeFill');
            const text = document.getElementById('gaugeText');
            const maxOffset = 251;
            gauge.style.strokeDashoffset = maxOffset - (pct / 100 * maxOffset);
            text.textContent = pct + '%';
            gauge.setAttribute('stroke', pct >= 85 ? '#10b981' : pct >= 70 ? '#f59e0b' : '#ef4444');
        }

        function renderBalanceChart() {
            const ctx = document.getElementById('balanceChart');
            if (!ctx || projectionData.length === 0) return;
            if (balanceChart) balanceChart.destroy();

            balanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: projectionData.map(d => d.age),
                    datasets: [{
                        label: 'Portfolio Balance',
                        data: projectionData.map(d => d.totalPortfolio),
                        borderColor: '#00205B',
                        backgroundColor: 'rgba(0, 32, 91, 0.1)',
                        fill: true, tension: 0.3
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => fC(ctx.raw) } } },
                    scales: { x: { title: { display: true, text: 'Age' } }, y: { title: { display: true, text: 'Portfolio' }, ticks: { callback: v => fC(v) } } }
                }
            });
        }

        function renderIncomeChart() {
            const ctx = document.getElementById('incomeChart');
            if (!ctx || projectionData.length === 0) return;
            if (incomeChart) incomeChart.destroy();

            const filtered = projectionData.filter((d, i) => i % 5 === 0);
            incomeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: filtered.map(d => d.age),
                    datasets: [
                        { label: 'Earnings', data: filtered.map(d => d.earnings), backgroundColor: '#00205B' },
                        { label: 'Social Security', data: filtered.map(d => d.ssIncome), backgroundColor: '#D4AF37' },
                        { label: 'Pension', data: filtered.map(d => d.pensionIncome), backgroundColor: '#10b981' },
                        { label: 'Other', data: filtered.map(d => d.otherIncome), backgroundColor: '#8b5cf6' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + fC(ctx.raw) } } },
                    scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: v => fC(v) } } }
                }
            });
        }

        function renderMCChart() {
            const ctx = document.getElementById('mcChart');
            if (!ctx || mcResults.paths.length === 0) return;
            if (mcChart) mcChart.destroy();

            const years = mcResults.paths[0].length;
            const labels = Array.from({ length: years }, (_, i) => getVal('client1Age') + i);

            const p5 = [], p25 = [], p50 = [], p75 = [], p95 = [];
            for (let y = 0; y < years; y++) {
                const yearVals = mcResults.paths.map(p => p[y] || 0).sort((a, b) => a - b);
                p5.push(yearVals[Math.floor(yearVals.length * 0.05)]);
                p25.push(yearVals[Math.floor(yearVals.length * 0.25)]);
                p50.push(yearVals[Math.floor(yearVals.length * 0.50)]);
                p75.push(yearVals[Math.floor(yearVals.length * 0.75)]);
                p95.push(yearVals[Math.floor(yearVals.length * 0.95)]);
            }

            mcChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: '95th', data: p95, borderColor: 'rgba(16,185,129,0.5)', backgroundColor: 'rgba(16,185,129,0.1)', fill: '+1', tension: 0.3, pointRadius: 0 },
                        { label: '75th', data: p75, borderColor: 'rgba(16,185,129,0.7)', backgroundColor: 'rgba(16,185,129,0.2)', fill: '+1', tension: 0.3, pointRadius: 0 },
                        { label: 'Median', data: p50, borderColor: '#00205B', backgroundColor: 'transparent', borderWidth: 3, tension: 0.3, pointRadius: 0 },
                        { label: '25th', data: p25, borderColor: 'rgba(245,158,11,0.7)', backgroundColor: 'rgba(245,158,11,0.2)', fill: '+1', tension: 0.3, pointRadius: 0 },
                        { label: '5th', data: p5, borderColor: 'rgba(239,68,68,0.5)', backgroundColor: 'rgba(239,68,68,0.1)', fill: 'origin', tension: 0.3, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + fC(ctx.raw) } } },
                    scales: { x: { title: { display: true, text: 'Age' } }, y: { title: { display: true, text: 'Portfolio' }, ticks: { callback: v => fC(v) } } }
                }
            });
        }

        function renderScenarioChart() {
            const ctx = document.getElementById('scenarioChart');
            if (!ctx || projectionData.length === 0) return;
            if (scenarioChart) scenarioChart.destroy();

            scenarioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: projectionData.map(d => d.age),
                    datasets: [{ label: 'Portfolio', data: projectionData.map(d => d.totalPortfolio), borderColor: '#00205B', backgroundColor: 'rgba(0,32,91,0.1)', fill: true, tension: 0.3 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { tooltip: { callbacks: { label: ctx => fC(ctx.raw) } } },
                    scales: { x: { title: { display: true, text: 'Age' } }, y: { title: { display: true, text: 'Portfolio' }, ticks: { callback: v => fC(v) } } }
                }
            });
        }

        function setScenario(scenario, btn) {
            document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            let overrides = {};
            switch (scenario) {
                case 'earlyRetire': overrides = { c1RetireAge: 62 }; break;
                case 'delayedSS': overrides = { ss1Age: 70, ss2Age: 70 }; break;
                case 'reducedSpend': overrides = { essential: getVal('essentialExpenses') * 0.85, discretionary: getVal('discretionaryExpenses') * 0.85 }; break;
                case 'marketCrash': overrides = { preReturn: -0.20, retReturn: 0.04 }; break;
            }

            runProjection(overrides);
            runMonteCarlo();
            renderScenarioChart();
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            // Tab click handlers
            document.querySelectorAll('.tab').forEach(function (tab) {
                tab.addEventListener('click', function () {
                    showTab(this.dataset.tab, this);
                });
            });

            // Scenario button handlers
            document.querySelectorAll('.scenario-btn').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    setScenario(this.dataset.scenario, this);
                });
            });

            // Spouse toggle
            document.getElementById('hasSpouse').addEventListener('change', function () {
                toggleSpouse();
                runProjection();
                runMonteCarlo();
            });

            // Monte Carlo button
            document.getElementById('runMCBtn').addEventListener('click', runMonteCarlo);

            // Slider updates
            ['inflation', 'preReturn', 'retReturn', 'volatility'].forEach(function (id) {
                document.getElementById(id).addEventListener('input', function () {
                    document.getElementById(id + 'Display').textContent = this.value + '%';
                });
            });

            // Input change handlers - run projection on any input change
            document.querySelectorAll('input, select').forEach(function (el) {
                el.addEventListener('change', function () {
                    runProjection();
                    runMonteCarlo();
                });
            });

            // Profile Sync with GlobalStateManager
            function loadFromProfile() {
                if (typeof GlobalStateManager === 'undefined') return;
                const state = GlobalStateManager.getState();

                // Personalize headers with actual client names
                const names = GlobalStateManager.getClientNames();
                const c1Header = document.querySelector('#tab-inputs .card:first-child h2');
                if (c1Header) c1Header.innerHTML = `<span class="icon"></span>${names.client1} Information`;
                const c2Header = document.querySelector('#tab-inputs .card:nth-child(2) h2');
                if (c2Header) c2Header.innerHTML = `<span class="icon"></span>${names.client2}`;
                const ss1Header = document.querySelector('#ss1FRA')?.closest('.card')?.querySelector('h2');
                if (ss1Header) ss1Header.innerHTML = `<span class="icon"></span>Social Security - ${names.client1}`;
                const ss2Header = document.querySelector('#ss2Card h2');
                if (ss2Header) ss2Header.innerHTML = `<span class="icon"></span>Social Security - ${names.client2}`;

                // Client 1
                if (state.client1?.age) document.getElementById('client1Age').value = state.client1.age;
                if (state.client1?.retirementAge) document.getElementById('client1RetireAge').value = state.client1.retirementAge;
                if (state.client1?.salary) document.getElementById('client1Salary').value = state.client1.salary;

                // Client 2
                if (state.client2?.age || state.client2?.name) {
                    document.getElementById('hasSpouse').checked = true;
                    toggleSpouse();
                    if (state.client2?.age) document.getElementById('client2Age').value = state.client2.age;
                    if (state.client2?.retirementAge) document.getElementById('client2RetireAge').value = state.client2.retirementAge;
                    if (state.client2?.salary) document.getElementById('client2Salary').value = state.client2.salary;
                }

                // Portfolio
                if (state.portfolio?.preTax) document.getElementById('preTaxBalance').value = state.portfolio.preTax;
                if (state.portfolio?.roth) document.getElementById('rothBalance').value = state.portfolio.roth;
                if (state.portfolio?.taxable) document.getElementById('taxableBalance').value = state.portfolio.taxable;

                // Social Security (convert monthly to match input format)
                if (state.socialSecurity?.client1FRA) document.getElementById('ss1FRA').value = state.socialSecurity.client1FRA;
                if (state.socialSecurity?.client2FRA) document.getElementById('ss2FRA').value = state.socialSecurity.client2FRA;
            }

            if (typeof GlobalStateManager !== 'undefined') {
                GlobalStateManager.init();
                loadFromProfile();

                GlobalStateManager.subscribe(function (state) {
                    loadFromProfile();
                    runProjection();
                    runMonteCarlo();
                });
            }

            // Initial run
            runProjection();
            runMonteCarlo();
        });
    </script>
</body>

</html>