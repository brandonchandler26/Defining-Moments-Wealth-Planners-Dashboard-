<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RMD vs Roth Conversion Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
  <!-- Shared Dashboard Libraries -->
  <script src="constants.js"></script>
  <script src="state-manager.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'brand-navy': '#00205B',
            'brand-navy-light': '#003380',
            'brand-gold': '#D4AF37',
            'brand-gold-hover': '#B5952F',
            'brand-light': '#F9F9F7',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

    body {
      font-family: 'DM Sans', sans-serif;
    }

    @media print {
      @page {
        size: landscape;
        margin: 0.5cm;
      }

      body {
        background: white;
      }

      .no-print {
        display: none !important;
      }
    }

    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #F9F9F7;
    }

    ::-webkit-scrollbar-thumb {
      background: #D4AF37;
      border-radius: 5px;
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #D4AF37;
      border-radius: 3px;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #D4AF37 !important;
      box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2) !important;
    }
  </style>
</head>

<body class="bg-brand-light text-gray-800">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;
    const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ComposedChart, Area, Bar } = Recharts;

    const IconWrapper = ({ children, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
    const Calculator = ({ className }) => <IconWrapper className={className}><rect width="16" height="20" x="4" y="2" rx="2" /><line x1="8" x2="16" y1="6" y2="6" /><line x1="16" x2="16" y1="14" y2="18" /><path d="M16 10h.01" /><path d="M12 10h.01" /><path d="M8 10h.01" /><path d="M12 14h.01" /><path d="M8 14h.01" /><path d="M12 18h.01" /><path d="M8 18h.01" /></IconWrapper>;
    const TrendingUp = ({ className }) => <IconWrapper className={className}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17" /><polyline points="16 7 22 7 22 13" /></IconWrapper>;
    const Layers = ({ className }) => <IconWrapper className={className}><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z" /><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65" /><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65" /></IconWrapper>;
    const ArrowRight = ({ className }) => <IconWrapper className={className}><path d="M5 12h14" /><path d="m12 5 7 7-7 7" /></IconWrapper>;
    const FileSpreadsheet = ({ className }) => <IconWrapper className={className}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" /><path d="M14 2v4a2 2 0 0 0 2 2h4" /><path d="M8 13h2" /><path d="M14 13h2" /><path d="M8 17h2" /><path d="M14 17h2" /></IconWrapper>;
    const Printer = ({ className }) => <IconWrapper className={className}><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect width="12" height="8" x="6" y="14" /></IconWrapper>;
    const ChevronDown = ({ className }) => <IconWrapper className={className}><path d="m6 9 6 6 6-6" /></IconWrapper>;
    const ChevronUp = ({ className }) => <IconWrapper className={className}><path d="m18 15-6-6-6 6" /></IconWrapper>;
    const RefreshCw = ({ className }) => <IconWrapper className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></IconWrapper>;
    const Percent = ({ className }) => <IconWrapper className={className}><line x1="19" y1="5" x2="5" y2="19" /><circle cx="6.5" cy="6.5" r="2.5" /><circle cx="17.5" cy="17.5" r="2.5" /></IconWrapper>;

    // Use RMD factors from shared constants
    const uniformLifetimeTable = (typeof FinancialConstants !== 'undefined' && FinancialConstants.rmdFactors) || { 72: 27.4, 73: 26.5, 74: 25.5, 75: 24.6, 76: 23.7, 77: 22.9, 78: 22.0, 79: 21.1, 80: 20.2, 81: 19.4, 82: 18.5, 83: 17.7, 84: 16.8, 85: 16.0, 86: 15.2, 87: 14.4, 88: 13.7, 89: 12.9, 90: 12.2, 91: 11.5, 92: 10.8, 93: 10.1, 94: 9.5, 95: 8.9, 96: 8.4, 97: 7.8, 98: 7.3, 99: 6.8, 100: 6.4, 101: 6.0, 102: 5.6, 103: 5.2, 104: 4.9, 105: 4.6, 106: 4.3, 107: 4.1, 108: 3.9, 109: 3.7, 110: 3.5, 111: 3.4, 112: 3.3, 113: 3.1, 114: 3.0, 115: 2.9, 116: 2.8, 117: 2.7, 118: 2.5, 119: 2.3, 120: 2.0 };

    // Validation constants
    const MIN_BIRTH_YEAR = 1920;
    const MAX_BIRTH_YEAR = 2010;
    const MAX_PROJECTION_AGE = 120;
    const MAX_TAX_RATE = 50;

    // Use shared getRMDStartAge if available
    const getRMDStartAge = (birthYear) => {
      if (typeof FinancialConstants !== 'undefined' && FinancialConstants.getRMDStartAge) {
        return FinancialConstants.getRMDStartAge(birthYear);
      }
      return birthYear >= 1960 ? 75 : 73;
    };

    // Get initial birth year from GlobalStateManager
    const getInitialBirthYear = () => {
      if (typeof GlobalStateManager !== 'undefined') {
        const birthYear = GlobalStateManager.getBirthYear(1);
        if (birthYear && birthYear >= MIN_BIRTH_YEAR && birthYear <= MAX_BIRTH_YEAR) {
          return birthYear;
        }
      }
      return 1960;
    };

    // Get initial balance from GlobalStateManager
    const getInitialBalance = () => {
      if (typeof GlobalStateManager !== 'undefined') {
        const state = GlobalStateManager.getState();
        if (state.portfolio?.preTax > 0) {
          return state.portfolio.preTax;
        }
      }
      return 500000;
    };

    const Card = ({ children, className = "" }) => <div className={`bg-white rounded-xl shadow-sm border border-gray-200 ${className}`}>{children}</div>;
    const formatCurrency = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
    const formatPercent = (val) => `${val > 0 ? '+' : ''}${val.toFixed(1)}%`;

    const generateStructuredMarketReturns = (targetYears) => {
      const returns = [];
      const crashes = { "gd": [-0.08, -0.25, -0.43, -0.08], "ww2": [-0.004, -0.10, -0.12], "dc": [-0.09, -0.12, -0.22], "stag": [-0.15, -0.26] };
      const randn = () => { let u = 0, v = 0; while (u === 0) u = Math.random(); while (v === 0) v = Math.random(); return Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v); };
      while (returns.length < targetYears) {
        const sr = Math.random(); let st = sr > 0.82 ? 'dynasty' : sr > 0.53 ? 'solid' : 'short';
        let dur = st === 'short' ? Math.floor(Math.random() * 3) + 1 : st === 'solid' ? Math.floor(Math.random() * 3) + 4 : Math.floor(Math.random() * 2) + 8;
        for (let i = 0; i < dur && returns.length < targetYears; i++) returns.push(Math.max(0.01, (0.15 + (randn() * 0.10))) * 100);
        if (returns.length >= targetYears) break;
        if (Math.random() < 0.24) { const cr = Math.random(); const cv = cr < 0.25 ? crashes.gd : cr < 0.50 ? crashes.ww2 : cr < 0.75 ? crashes.dc : crashes.stag; for (let v of cv) { if (returns.length >= targetYears) break; returns.push(v * 100); } }
        else returns.push(Math.min(-0.01, (-0.10 + (randn() * 0.05))) * 100);
      }
      return returns.slice(0, targetYears);
    };

    const calculateProjection = (birthYear, currentBalance, returnSequence, standardPreRMD, preRMDOverrides, standardRothConv, rothConvOverrides, rmdStartAge, endAge, fedTaxRate, stateTaxRate, delayFirstRMD = false) => {
      const currentYear = new Date().getFullYear(), currentAge = currentYear - birthYear, totalTaxRate = (fedTaxRate + stateTaxRate) / 100;
      let tradBalance = currentBalance, rothBalance = 0, age = currentAge, year = currentYear, data = [], idx = 0, totalRMDTaken = 0, totalConverted = 0, totalTaxesPaid = 0;
      let firstRMDDelayed = false, delayedRMDAmount = 0;
      while (age <= endAge) {
        const isRMDYear = age >= rmdStartAge, rate = returnSequence[idx] !== undefined ? returnSequence[idx] : 6.0;
        const tradGrowth = tradBalance * (rate / 100), rothGrowth = rothBalance * (rate / 100);
        let withdrawal = 0, conversion = 0, isRMD = false, rmdFactor = null;
        if (isRMDYear) {
          isRMD = true;
          rmdFactor = uniformLifetimeTable[age] || uniformLifetimeTable[120];
          let currentYearRMD = tradBalance / rmdFactor;

          // Handle first RMD delay (April 1 rule)
          if (delayFirstRMD && age === rmdStartAge && !firstRMDDelayed) {
            // First RMD year - delay to next year
            delayedRMDAmount = currentYearRMD;
            withdrawal = 0;
            firstRMDDelayed = true;
          } else if (delayFirstRMD && age === rmdStartAge + 1 && delayedRMDAmount > 0) {
            // Second RMD year with delay - pay both
            withdrawal = currentYearRMD + delayedRMDAmount;
            delayedRMDAmount = 0;
          } else {
            withdrawal = currentYearRMD;
          }
          totalRMDTaken += withdrawal;
        }
        else { withdrawal = preRMDOverrides[age] !== undefined ? parseFloat(preRMDOverrides[age]) : parseFloat(standardPreRMD); conversion = rothConvOverrides[age] !== undefined ? parseFloat(rothConvOverrides[age]) : parseFloat(standardRothConv); }
        let tradEndBalance = tradBalance + tradGrowth - withdrawal - conversion;
        if (tradEndBalance < 0) { const avail = Math.max(0, tradBalance + tradGrowth); if (withdrawal > avail) { withdrawal = avail; conversion = 0; } else { conversion = avail - withdrawal; } tradEndBalance = 0; }
        const taxPaid = (withdrawal + conversion) * totalTaxRate; totalTaxesPaid += taxPaid; totalConverted += conversion;
        let rothEndBalance = rothBalance + rothGrowth + conversion;
        data.push({ year, age, rate, tradStartBalance: tradBalance, tradGrowth, withdrawal, conversion, isRMD, rmdFactor, tradEndBalance, rothStartBalance: rothBalance, rothGrowth, rothEndBalance, totalEndBalance: tradEndBalance + rothEndBalance, taxPaid });
        if (tradEndBalance <= 0 && rothEndBalance <= 0 && age > 100) break;
        tradBalance = tradEndBalance; rothBalance = rothEndBalance; age++; year++; idx++;
      }
      return { data, finalTradBalance: data[data.length - 1]?.tradEndBalance || 0, finalRothBalance: data[data.length - 1]?.rothEndBalance || 0, totalRMDTaken, totalConverted, totalTaxesPaid };
    };

    const App = () => {
      const currentYear = new Date().getFullYear();
      const [birthYear, setBirthYear] = useState(getInitialBirthYear());
      const [currentBalance, setCurrentBalance] = useState(getInitialBalance());
      const [endAge, setEndAge] = useState(95);
      const [standardPreRMD, setStandardPreRMD] = useState(0);
      const [standardRothConv, setStandardRothConv] = useState(0);
      const [fedTaxRate, setFedTaxRate] = useState(22);
      const [stateTaxRate, setStateTaxRate] = useState(5);
      const [returnMode, setReturnMode] = useState('fixed');
      const [rateOfReturn, setRateOfReturn] = useState(6.0);
      const [singleSequence, setSingleSequence] = useState([]);
      const [monteCarloStats, setMonteCarloStats] = useState(null);
      const [preRMDOverrides, setPreRMDOverrides] = useState({});
      const [rothConvOverrides, setRothConvOverrides] = useState({});
      const [showOverrides, setShowOverrides] = useState(false);
      const [delayFirstRMD, setDelayFirstRMD] = useState(false);

      // Input validation handlers
      const validateBirthYear = (val) => Math.max(MIN_BIRTH_YEAR, Math.min(MAX_BIRTH_YEAR, Number(val) || 1965));
      const validateBalance = (val) => Math.max(0, Number(val) || 0);
      const validateEndAge = (val, minAge) => Math.max(minAge, Math.min(MAX_PROJECTION_AGE, Number(val) || 95));
      const validateTaxRate = (val) => Math.max(0, Math.min(MAX_TAX_RATE, Number(val) || 0));

      const currentAge = currentYear - birthYear;
      const rmdStartAge = getRMDStartAge(birthYear);
      const yearsUntilRMD = rmdStartAge - currentAge;

      const runMonteCarlo = useCallback(() => {
        const iterations = 1000, results = [], baselineResults = [], yearsToProject = Math.max(1, endAge - currentAge + 5);
        for (let i = 0; i < iterations; i++) {
          const sequence = generateStructuredMarketReturns(yearsToProject);
          const strategyRun = calculateProjection(birthYear, currentBalance, sequence, standardPreRMD, preRMDOverrides, standardRothConv, rothConvOverrides, rmdStartAge, endAge, fedTaxRate, stateTaxRate, delayFirstRMD);
          const baselineRun = calculateProjection(birthYear, currentBalance, sequence, 0, {}, 0, {}, rmdStartAge, endAge, fedTaxRate, stateTaxRate, false);
          results.push({ finalTotalBalance: strategyRun.finalTradBalance + strategyRun.finalRothBalance, finalTradBalance: strategyRun.finalTradBalance, finalRothBalance: strategyRun.finalRothBalance, totalRMDTaken: strategyRun.totalRMDTaken, totalTaxesPaid: strategyRun.totalTaxesPaid, data: strategyRun.data, sequence });
          baselineResults.push({ finalTotalBalance: baselineRun.finalTradBalance, totalRMDTaken: baselineRun.totalRMDTaken, totalTaxesPaid: baselineRun.totalTaxesPaid });
        }
        results.sort((a, b) => a.finalTotalBalance - b.finalTotalBalance);
        baselineResults.sort((a, b) => a.finalTotalBalance - b.finalTotalBalance);
        const p10 = results[Math.floor(iterations * 0.1)], p50 = results[Math.floor(iterations * 0.5)], p90 = results[Math.floor(iterations * 0.9)], p50Baseline = baselineResults[Math.floor(iterations * 0.5)];
        setMonteCarloStats({ p10, p50, p90, medianBaselineRMD: p50Baseline.totalRMDTaken, medianStrategyRMD: p50.totalRMDTaken, medianTotalConverted: p50.data.reduce((a, r) => a + r.conversion, 0), medianStrategyTaxes: p50.totalTaxesPaid, medianBaselineTaxes: p50Baseline.totalTaxesPaid });
        setReturnMode('monte_carlo');
      }, [birthYear, currentAge, currentBalance, standardPreRMD, preRMDOverrides, standardRothConv, rothConvOverrides, rmdStartAge, endAge, fedTaxRate, stateTaxRate, delayFirstRMD]);

      const generateSinglePath = useCallback((mode) => {
        const yearsToProject = Math.max(1, endAge - currentAge + 5);
        const sequence = mode === 'fixed' ? Array(yearsToProject).fill(parseFloat(rateOfReturn)) : generateStructuredMarketReturns(yearsToProject);
        setSingleSequence(sequence);
        setReturnMode(mode === 'fixed' ? 'fixed' : 'simulated_single');
        setMonteCarloStats(null);
      }, [rateOfReturn, currentAge, endAge]);

      useEffect(() => { if (returnMode !== 'monte_carlo') generateSinglePath(returnMode === 'fixed' ? 'fixed' : 'simulated_single'); }, [endAge]);

      const { displayData, comparisonStats, breakdown } = useMemo(() => {
        if (returnMode === 'monte_carlo' && monteCarloStats) {
          return { displayData: monteCarloStats.p50.data, comparisonStats: { rmdStrategy: monteCarloStats.medianStrategyRMD, rmdBaseline: monteCarloStats.medianBaselineRMD, taxesStrategy: monteCarloStats.medianStrategyTaxes, taxesBaseline: monteCarloStats.medianBaselineTaxes, isMedian: true }, breakdown: { trad: monteCarloStats.p50.finalTradBalance, roth: monteCarloStats.p50.finalRothBalance } };
        }
        const sequenceToUse = singleSequence.length ? singleSequence : Array(100).fill(6);
        const strategyRun = calculateProjection(birthYear, currentBalance, sequenceToUse, standardPreRMD, preRMDOverrides, standardRothConv, rothConvOverrides, rmdStartAge, endAge, fedTaxRate, stateTaxRate, delayFirstRMD);
        const baselineRun = calculateProjection(birthYear, currentBalance, sequenceToUse, 0, {}, 0, {}, rmdStartAge, endAge, fedTaxRate, stateTaxRate, false);
        return { displayData: strategyRun.data, comparisonStats: { rmdStrategy: strategyRun.totalRMDTaken, rmdBaseline: baselineRun.totalRMDTaken, taxesStrategy: strategyRun.totalTaxesPaid, taxesBaseline: baselineRun.totalTaxesPaid, isMedian: false }, breakdown: { trad: strategyRun.finalTradBalance, roth: strategyRun.finalRothBalance } };
      }, [returnMode, monteCarloStats, singleSequence, birthYear, currentBalance, standardPreRMD, preRMDOverrides, standardRothConv, rothConvOverrides, rmdStartAge, endAge, fedTaxRate, stateTaxRate, delayFirstRMD]);

      const firstRMD = displayData.find(d => d.isRMD);
      const finalTotalBalance = breakdown.trad + breakdown.roth;
      const chartData = useMemo(() => {
        if (returnMode !== 'monte_carlo' || !monteCarloStats) return displayData;
        const { p10, p50, p90 } = monteCarloStats;
        return p50.data.map((row, i) => ({ ...row, p10Balance: p10.data[i]?.totalEndBalance, p90Balance: p90.data[i]?.totalEndBalance }));
      }, [displayData, returnMode, monteCarloStats]);

      const rmdDifference = comparisonStats.rmdBaseline - comparisonStats.rmdStrategy;
      const taxDifference = comparisonStats.taxesBaseline - comparisonStats.taxesStrategy;

      const handleExportCSV = () => {
        const headers = ["Age", "Year", "TradBalance", "RothBalance", "Return%", "Withdrawal", "Conversion", "TaxPaid", "TotalEndBalance"];
        const rows = displayData.map(r => [r.age, r.year, r.tradStartBalance.toFixed(2), r.rothStartBalance.toFixed(2), r.rate.toFixed(2), r.withdrawal.toFixed(2), r.conversion.toFixed(2), r.taxPaid.toFixed(2), r.totalEndBalance.toFixed(2)]);
        const csv = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows.map(e => e.join(","))].join("\n");
        const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "rmd_roth_projection.csv"; link.click();
      };

      return (
        <div className="min-h-screen bg-brand-light font-sans text-gray-800">
          <div className="no-print p-4 md:p-6">
            <div className="max-w-7xl mx-auto space-y-5">
              <div className="text-center pb-5 border-b-4 border-brand-gold">
                <h1 className="text-2xl md:text-3xl font-bold text-brand-navy flex items-center justify-center gap-3"><Calculator className="w-7 h-7 text-brand-gold" />RMD vs Roth Conversion Tool</h1>
                <p className="text-gray-500 mt-1 text-sm">SECURE 2.0 Compliant • Monte Carlo Analysis • Conversion Strategy</p>
                <div className="flex justify-center gap-3 mt-4">
                  <button onClick={handleExportCSV} className="flex items-center gap-2 px-4 py-2 bg-brand-navy hover:bg-brand-navy-light text-white rounded-lg font-semibold text-sm shadow-sm"><FileSpreadsheet className="w-4 h-4" />Export CSV</button>
                  <button onClick={() => window.print()} className="flex items-center gap-2 px-4 py-2 bg-brand-gold hover:bg-brand-gold-hover text-brand-navy rounded-lg font-semibold text-sm shadow-sm"><Printer className="w-4 h-4" />Print</button>
                </div>
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-12 gap-5">
                <div className="lg:col-span-4 space-y-4">
                  <Card>
                    <div className="bg-brand-navy text-white p-3 rounded-t-xl flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-brand-gold"></span><h2 className="text-sm font-semibold uppercase tracking-wide">Client Inputs</h2></div>
                    <div className="p-4 space-y-4">
                      <div className="grid grid-cols-2 gap-3">
                        <div><label className="block text-xs font-bold text-brand-navy mb-1 uppercase">Birth Year</label><input type="number" value={birthYear} onChange={(e) => setBirthYear(validateBirthYear(e.target.value))} min={MIN_BIRTH_YEAR} max={MAX_BIRTH_YEAR} className="w-full p-2 border-2 border-gray-200 rounded-md font-mono text-sm" /></div>
                        <div><label className="block text-xs font-bold text-brand-navy mb-1 uppercase">Project to Age</label><input type="number" value={endAge} onChange={(e) => setEndAge(validateEndAge(e.target.value, currentAge))} min={currentAge} max={MAX_PROJECTION_AGE} className="w-full p-2 border-2 border-gray-200 rounded-md font-mono text-sm" /></div>
                      </div>
                      <div className="text-xs text-gray-500">RMD Start Age: <span className="font-bold text-brand-navy">{rmdStartAge}</span> ({yearsUntilRMD > 0 ? `${yearsUntilRMD} years away` : 'RMDs have begun'})</div>
                      {yearsUntilRMD > 0 && (<div className="flex items-center gap-2 bg-brand-light p-2 rounded-md border border-gray-200"><input type="checkbox" id="delayRMD" checked={delayFirstRMD} onChange={(e) => setDelayFirstRMD(e.target.checked)} className="w-4 h-4 accent-brand-gold cursor-pointer" /><label htmlFor="delayRMD" className="text-xs text-gray-600 cursor-pointer">Delay first RMD to April 1 of following year <span className="text-[10px] text-gray-400">(results in 2 RMDs in year 2)</span></label></div>)}
                      <div><label className="block text-xs font-bold text-brand-navy mb-1 uppercase">Current Traditional Balance</label><div className="relative"><span className="absolute left-3 top-2.5 text-gray-400 font-mono text-sm">$</span><input type="number" value={currentBalance} onChange={(e) => setCurrentBalance(validateBalance(e.target.value))} min={0} className="w-full pl-7 p-2 border-2 border-gray-200 rounded-md font-mono text-sm" /></div></div>

                      <div className="bg-brand-light p-3 rounded-lg border border-gray-200">
                        <label className="block text-xs font-bold text-brand-navy mb-2 uppercase">Return Strategy</label>
                        {returnMode === 'fixed' && (<div className="relative mb-2"><input type="number" value={rateOfReturn} step="0.1" onChange={(e) => { setRateOfReturn(Number(e.target.value)); generateSinglePath('fixed'); }} className="w-full p-2 border-2 border-gray-200 rounded-md font-mono text-sm" /><span className="absolute right-3 top-2.5 text-gray-400 text-sm">%</span></div>)}
                        <div className="flex flex-col gap-2">
                          <button onClick={() => generateSinglePath('fixed')} className={`px-3 py-2 text-xs font-semibold rounded-lg border-2 flex items-center justify-center gap-2 ${returnMode === 'fixed' ? 'bg-brand-navy text-white border-brand-navy' : 'bg-white text-brand-navy border-brand-navy hover:bg-brand-light'}`}><TrendingUp className="w-3 h-3" />Fixed Rate</button>
                          <button onClick={runMonteCarlo} className={`px-3 py-2 text-xs font-semibold rounded-lg border-2 flex items-center justify-center gap-2 ${returnMode === 'monte_carlo' ? 'bg-brand-gold text-brand-navy border-brand-gold' : 'bg-white text-brand-navy border-brand-gold hover:bg-yellow-50'}`}><Layers className="w-3 h-3" />Monte Carlo (1,000 Sims)</button>
                        </div>
                      </div>

                      <div className="bg-brand-light p-3 rounded-lg border border-gray-200">
                        <label className="block text-xs font-bold text-brand-navy mb-2 uppercase flex items-center gap-2"><Percent className="w-4 h-4" />Est. Tax Rates</label>
                        <div className="grid grid-cols-2 gap-3">
                          <div><label className="block text-xs font-semibold text-gray-600 mb-1">Federal</label><div className="relative"><input type="number" value={fedTaxRate} onChange={(e) => setFedTaxRate(validateTaxRate(e.target.value))} min={0} max={MAX_TAX_RATE} className="w-full p-2 pr-8 border-2 border-gray-200 rounded-md font-mono text-sm" /><span className="absolute right-3 top-2.5 text-gray-400 text-sm">%</span></div></div>
                          <div><label className="block text-xs font-semibold text-gray-600 mb-1">State</label><div className="relative"><input type="number" value={stateTaxRate} onChange={(e) => setStateTaxRate(validateTaxRate(e.target.value))} min={0} max={MAX_TAX_RATE} className="w-full p-2 pr-8 border-2 border-gray-200 rounded-md font-mono text-sm" /><span className="absolute right-3 top-2.5 text-gray-400 text-sm">%</span></div></div>
                        </div>
                        <p className="text-[10px] text-gray-400 mt-2 italic">⚠️ Note: Uses flat combined rate. Actual tax depends on brackets and other income.</p>
                      </div>

                      <div className="bg-gradient-to-br from-brand-gold/10 to-white p-3 rounded-lg border-2 border-brand-gold/30">
                        <label className="block text-xs font-bold text-brand-navy mb-2 uppercase flex items-center gap-2"><RefreshCw className="w-4 h-4 text-brand-gold" />Pre-RMD Strategy</label>
                        <div className="space-y-3">
                          <div><label className="block text-xs font-semibold text-gray-600 mb-1">Annual Withdrawal (Spend)</label><div className="relative"><span className="absolute left-3 top-2.5 text-gray-400 font-mono text-sm">$</span><input type="number" value={standardPreRMD} onChange={(e) => setStandardPreRMD(Number(e.target.value))} className="w-full pl-7 p-2 border-2 border-brand-gold/30 rounded-md font-mono text-sm" /></div></div>
                          <div><label className="block text-xs font-semibold text-brand-navy mb-1">Annual Roth Conversion (Save)</label><div className="relative"><span className="absolute left-3 top-2.5 text-gray-400 font-mono text-sm">$</span><input type="number" value={standardRothConv} onChange={(e) => setStandardRothConv(Number(e.target.value))} className="w-full pl-7 p-2 border-2 border-brand-navy/30 rounded-md font-mono text-sm bg-brand-navy/5" /></div></div>
                        </div>
                        {yearsUntilRMD > 0 && (<div className="mt-3 pt-3 border-t border-brand-gold/30"><button onClick={() => setShowOverrides(!showOverrides)} className="text-xs text-brand-navy font-semibold flex items-center hover:text-brand-gold">{showOverrides ? <ChevronUp className="w-4 h-4 mr-1" /> : <ChevronDown className="w-4 h-4 mr-1" />}Customize By Year</button>
                          {showOverrides && (<div className="mt-2 space-y-1 max-h-48 overflow-y-auto pr-2 custom-scrollbar">{displayData.filter(d => !d.isRMD).map((row) => (<div key={row.age} className="grid grid-cols-12 gap-1 items-center text-xs"><div className="col-span-3 text-gray-600 font-bold">{row.year}<br /><span className="font-normal text-[9px]">Age {row.age}</span></div><div className="col-span-4"><input type="number" placeholder="W/D" value={preRMDOverrides[row.age] !== undefined ? preRMDOverrides[row.age] : ''} onChange={(e) => setPreRMDOverrides({ ...preRMDOverrides, [row.age]: parseFloat(e.target.value) || 0 })} className="w-full p-1 border border-gray-300 rounded text-xs font-mono" /></div><div className="col-span-5"><input type="number" placeholder="Conv." value={rothConvOverrides[row.age] !== undefined ? rothConvOverrides[row.age] : ''} onChange={(e) => setRothConvOverrides({ ...rothConvOverrides, [row.age]: parseFloat(e.target.value) || 0 })} className="w-full p-1 border border-brand-navy/30 bg-brand-navy/5 rounded text-xs font-mono" /></div></div>))}</div>)}
                        </div>)}
                      </div>
                    </div>
                  </Card>
                </div>

                <div className="lg:col-span-8 space-y-4">
                  <Card className="overflow-hidden">
                    <div className="bg-brand-navy text-white p-3 flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-brand-gold"></span><h3 className="text-sm font-semibold uppercase tracking-wide">Lifetime Tax Comparison</h3></div>
                    <div className="p-4 bg-gradient-to-br from-brand-light to-green-50/30">
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <div className="text-center md:text-left"><div className="text-xs text-gray-500 uppercase font-bold">Your Strategy Taxes</div><div className="text-xl font-bold text-brand-navy font-mono">{formatCurrency(comparisonStats.taxesStrategy)}</div></div>
                        <div className="hidden md:flex justify-center text-gray-300"><ArrowRight className="w-6 h-6" /></div>
                        <div className="text-center md:text-left"><div className="text-xs text-gray-500 uppercase font-bold">Do Nothing (Baseline)</div><div className="text-xl font-bold text-gray-600 font-mono">{formatCurrency(comparisonStats.taxesBaseline)}</div></div>
                      </div>
                      <div className="mt-3 pt-3 border-t border-gray-200 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                        <span className="text-sm font-medium text-gray-600">Net Tax Impact:</span>
                        <span className={`text-lg font-bold font-mono ${taxDifference >= 0 ? 'text-green-600' : 'text-red-600'}`}>{taxDifference >= 0 ? 'Savings: ' : 'Extra Cost: '}{formatCurrency(Math.abs(taxDifference))}</span>
                      </div>
                    </div>
                  </Card>

                  <Card className="overflow-hidden">
                    <div className="bg-brand-navy text-white p-3 flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-brand-gold"></span><h3 className="text-sm font-semibold uppercase tracking-wide">Lifetime RMD Analysis</h3></div>
                    <div className="p-4">
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                        <div className="text-center md:text-left"><div className="text-xs text-gray-500 uppercase font-bold">Your Strategy RMDs</div><div className="text-xl font-bold text-brand-navy font-mono">{formatCurrency(comparisonStats.rmdStrategy)}</div></div>
                        <div className="hidden md:flex justify-center text-gray-300"><ArrowRight className="w-6 h-6" /></div>
                        <div className="text-center md:text-left"><div className="text-xs text-gray-500 uppercase font-bold">No Action Baseline</div><div className="text-xl font-bold text-gray-600 font-mono">{formatCurrency(comparisonStats.rmdBaseline)}</div></div>
                      </div>
                      <div className="mt-3 pt-3 border-t border-gray-200 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                        <span className="text-sm font-medium text-gray-600">RMD Reduction:</span>
                        <span className={`text-lg font-bold font-mono ${rmdDifference >= 0 ? 'text-green-600' : 'text-red-600'}`}>{rmdDifference >= 0 ? formatCurrency(rmdDifference) : `+${formatCurrency(Math.abs(rmdDifference))}`}</span>
                      </div>
                    </div>
                  </Card>

                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <Card className="p-3 text-center border-2 border-brand-gold"><div className="text-xs text-gray-500 uppercase font-bold">End Trad. Balance</div><div className="text-lg font-bold text-brand-navy font-mono mt-1">{formatCurrency(breakdown.trad)}</div></Card>
                    <Card className="p-3 text-center border-2 border-brand-navy"><div className="text-xs text-gray-500 uppercase font-bold">End Roth Balance</div><div className="text-lg font-bold text-brand-navy font-mono mt-1">{formatCurrency(breakdown.roth)}</div></Card>
                    <Card className="p-3 text-center"><div className="text-xs text-gray-500 uppercase font-bold">First RMD</div><div className="text-lg font-bold text-brand-gold font-mono mt-1">{firstRMD ? formatCurrency(firstRMD.withdrawal) : '-'}</div><div className="text-[10px] text-gray-400">Age {rmdStartAge}</div></Card>
                    <Card className="p-3 text-center bg-brand-navy"><div className="text-xs text-brand-gold uppercase font-bold">Total Wealth</div><div className="text-lg font-bold text-white font-mono mt-1">{formatCurrency(finalTotalBalance)}</div><div className="text-[10px] text-gray-300">At age {endAge}</div></Card>
                  </div>

                  <Card className="overflow-hidden">
                    <div className="bg-brand-navy text-white p-3 flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-brand-gold"></span><h3 className="text-sm font-semibold uppercase tracking-wide">Balance Projection {returnMode === 'monte_carlo' && '(Median)'}</h3></div>
                    <div className="p-4 h-72">
                      <ResponsiveContainer width="100%" height="100%">
                        <ComposedChart data={chartData}>
                          <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                          <XAxis dataKey="age" tick={{ fontSize: 10 }} />
                          <YAxis yAxisId="left" tickFormatter={(v) => `$${(v / 1000000).toFixed(1)}M`} tick={{ fontSize: 10 }} />
                          <Tooltip formatter={(value, name) => name.includes('Rate') ? formatPercent(value) : formatCurrency(value)} contentStyle={{ borderRadius: '8px', border: '2px solid #D4AF37' }} />
                          <Legend wrapperStyle={{ fontSize: '11px' }} />
                          <Area yAxisId="left" type="monotone" stackId="1" dataKey="tradEndBalance" name="Trad Balance" fill="#00205B" fillOpacity={0.3} stroke="#00205B" strokeWidth={2} />
                          <Area yAxisId="left" type="monotone" stackId="1" dataKey="rothEndBalance" name="Roth Balance" fill="#D4AF37" fillOpacity={0.5} stroke="#D4AF37" strokeWidth={2} />
                          {returnMode === 'monte_carlo' && (<><Line yAxisId="left" type="monotone" dataKey="p10Balance" name="10th %ile" stroke="#ef4444" strokeWidth={1} dot={false} strokeDasharray="5 5" /><Line yAxisId="left" type="monotone" dataKey="p90Balance" name="90th %ile" stroke="#10b981" strokeWidth={1} dot={false} strokeDasharray="5 5" /></>)}
                          <Bar yAxisId="left" dataKey="withdrawal" name="Withdrawal" fill="#f97316" radius={[3, 3, 0, 0]} opacity={0.7} />
                          <Bar yAxisId="left" dataKey="conversion" name="Roth Conv." fill="#8b5cf6" radius={[3, 3, 0, 0]} opacity={0.6} />
                        </ComposedChart>
                      </ResponsiveContainer>
                    </div>
                  </Card>

                  <Card className="overflow-hidden">
                    <div className="bg-brand-navy text-white p-3 flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-brand-gold"></span><h3 className="text-sm font-semibold uppercase tracking-wide">Annual Schedule {returnMode === 'monte_carlo' && "(Median)"}</h3></div>
                    <div className="overflow-x-auto max-h-80 overflow-y-auto">
                      <table className="w-full text-xs text-left">
                        <thead className="bg-brand-light text-brand-navy font-semibold sticky top-0 z-10 shadow-sm">
                          <tr><th className="p-2 pl-4">Age</th><th className="p-2">Year</th><th className="p-2">RMD Factor</th><th className="p-2 text-right">Trad Bal</th><th className="p-2 text-right">Roth Bal</th><th className="p-2 text-center">Return</th><th className="p-2 text-right">W/D</th><th className="p-2 text-right">Conv</th><th className="p-2 text-right">Total</th></tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                          {displayData.map((row) => (
                            <tr key={row.age} className={`hover:bg-brand-light ${row.isRMD ? 'bg-brand-gold/10' : ''}`}>
                              <td className="p-2 pl-4 font-semibold text-brand-navy flex items-center gap-1">{row.age}{row.isRMD && row.age === rmdStartAge && <span className="text-[8px] bg-brand-gold text-brand-navy px-1 py-0.5 rounded font-bold">RMD</span>}</td>
                              <td className="p-2 text-gray-500">{row.year}</td>
                              <td className="p-2 text-gray-500 text-center font-mono">{row.rmdFactor || '-'}</td>
                              <td className="p-2 text-brand-navy font-mono text-right">{formatCurrency(row.tradStartBalance)}</td>
                              <td className="p-2 text-brand-gold font-mono text-right">{formatCurrency(row.rothStartBalance)}</td>
                              <td className="p-2 text-center"><span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${row.rate < 0 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{formatPercent(row.rate)}</span></td>
                              <td className="p-2 text-orange-600 font-mono font-medium text-right">{row.withdrawal > 0 ? formatCurrency(row.withdrawal) : '-'}</td>
                              <td className="p-2 text-purple-600 font-mono font-medium text-right">{row.conversion > 0 ? formatCurrency(row.conversion) : '-'}</td>
                              <td className="p-2 font-bold text-brand-navy font-mono text-right">{formatCurrency(row.totalEndBalance)}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </Card>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Initialize GlobalStateManager for cross-tool communication
    if (typeof GlobalStateManager !== 'undefined') {
      GlobalStateManager.init();
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>

</html>