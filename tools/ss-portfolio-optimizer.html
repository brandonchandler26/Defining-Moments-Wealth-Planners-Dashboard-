<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Security & Portfolio Optimizer</title>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Shared Dashboard Libraries -->
    <script src="constants.js"></script>
    <script src="state-manager.js"></script>
    <style>
        :root {
            --brand-navy: #00205B;
            --brand-navy-light: #003380;
            --brand-gold: #D4AF37;
            --brand-gold-hover: #B5952F;
            --brand-light: #F9F9F7;
            --brand-white: #FFFFFF;
            --text-primary: #1a1a2e;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border: #E2E8F0;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--brand-light);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--brand-light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--brand-gold);
            border-radius: 5px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 24px;
        }

        header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--brand-gold);
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--brand-navy);
            margin-bottom: 4px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 24px;
        }

        @media (max-width: 1200px) {
            .grid-layout {
                grid-template-columns: 1fr;
            }
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .card {
            background: var(--brand-white);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 32, 91, 0.08);
        }

        .card-header {
            background: var(--brand-navy);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-header h2 {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--brand-white);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-header .icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--brand-gold);
        }

        .card-body {
            padding: 16px;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        .input-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--brand-navy);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .input-row .input-group {
            flex: 1;
            margin-bottom: 0;
        }

        input[type="number"],
        input[type="text"],
        select {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            padding: 8px 10px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: var(--brand-white);
            color: var(--text-primary);
            width: 100%;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--brand-gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
        }

        .input-with-prefix {
            position: relative;
        }

        .input-with-prefix .prefix {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 13px;
        }

        .input-with-prefix input {
            padding-left: 22px;
        }

        .input-with-suffix {
            position: relative;
        }

        .input-with-suffix .suffix {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 13px;
        }

        .input-with-suffix input {
            padding-right: 28px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--brand-navy);
            margin: 16px 0 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-title:first-child {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .checkbox-row input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--brand-gold);
        }

        .checkbox-row label {
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .btn {
            padding: 10px 16px;
            border: 2px solid var(--brand-navy);
            border-radius: 6px;
            background: var(--brand-white);
            color: var(--brand-navy);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--brand-navy);
            color: var(--brand-white);
        }

        .btn.primary {
            background: var(--brand-gold);
            border-color: var(--brand-gold);
            color: var(--brand-navy);
        }

        .btn.primary:hover {
            background: var(--brand-gold-hover);
        }

        .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-row .btn {
            flex: 1;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .tabs {
            display: flex;
            gap: 4px;
            background: var(--brand-white);
            padding: 4px;
            border-radius: 8px;
            border: 2px solid var(--border);
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
        }

        .tab.active {
            background: var(--brand-navy);
            color: var(--brand-white);
        }

        .tab:hover:not(.active) {
            background: var(--brand-light);
        }

        .scenario-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .scenario-tab {
            padding: 8px 16px;
            border: 2px solid var(--border);
            border-radius: 20px;
            background: var(--brand-white);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scenario-tab:hover {
            border-color: var(--brand-gold);
        }

        .scenario-tab.active {
            background: var(--brand-navy);
            border-color: var(--brand-navy);
            color: var(--brand-white);
        }

        .scenario-tab.bear {
            border-left: 4px solid var(--danger);
        }

        .scenario-tab.low {
            border-left: 4px solid var(--warning);
        }

        .scenario-tab.moderate {
            border-left: 4px solid var(--brand-navy);
        }

        .scenario-tab.high {
            border-left: 4px solid var(--success);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .result-card {
            background: var(--brand-white);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }

        .result-card.highlight {
            border-color: var(--brand-gold);
            background: linear-gradient(135deg, var(--brand-navy), var(--brand-navy-light));
        }

        .result-card.highlight .result-label,
        .result-card.highlight .result-value {
            color: var(--brand-white);
        }

        .result-card.highlight .result-value {
            color: var(--brand-gold);
        }

        .result-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .result-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 20px;
            font-weight: 700;
            color: var(--brand-navy);
        }

        .result-sub {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .chart-container {
            background: var(--brand-white);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--brand-navy);
            margin-bottom: 16px;
        }

        .chart-wrapper {
            height: 350px;
            position: relative;
        }

        .strategy-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .strategy-card {
            background: var(--brand-white);
            border: 2px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .strategy-card.best {
            border-color: var(--brand-gold);
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.2);
        }

        .strategy-header {
            background: var(--brand-light);
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .strategy-card.best .strategy-header {
            background: var(--brand-navy);
        }

        .strategy-card.best .strategy-header * {
            color: var(--brand-white);
        }

        .strategy-name {
            font-weight: 700;
            color: var(--brand-navy);
            font-size: 14px;
        }

        .strategy-badge {
            padding: 4px 10px;
            background: var(--brand-gold);
            color: var(--brand-navy);
            font-size: 10px;
            font-weight: 700;
            border-radius: 10px;
            text-transform: uppercase;
        }

        .strategy-body {
            padding: 16px;
        }

        .strategy-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        .strategy-row:last-child {
            border-bottom: none;
        }

        .strategy-row .label {
            color: var(--text-secondary);
        }

        .strategy-row .value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--text-primary);
        }

        .strategy-row .value.positive {
            color: var(--success);
        }

        .strategy-row .value.negative {
            color: var(--danger);
        }

        .timeline-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .timeline-table th {
            text-align: left;
            padding: 10px 8px;
            background: var(--brand-navy);
            color: var(--brand-white);
            font-weight: 600;
        }

        .timeline-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }

        .timeline-table tr:nth-child(even) td {
            background: var(--brand-light);
        }

        .timeline-table .number {
            font-family: 'JetBrains Mono', monospace;
            text-align: right;
        }

        .timeline-table .positive {
            color: var(--success);
        }

        .timeline-table .negative {
            color: var(--danger);
        }

        .info-box {
            background: rgba(0, 32, 91, 0.05);
            border: 1px solid var(--brand-navy);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .info-box strong {
            color: var(--brand-navy);
        }

        .help-text {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .age-slider-container {
            margin: 8px 0;
        }

        .age-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--border);
            appearance: none;
            cursor: pointer;
        }

        .age-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--brand-gold);
            border: 2px solid var(--brand-white);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        .age-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .spouse-section {
            background: var(--brand-light);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .spouse-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .spouse-toggle input {
            width: 18px;
            height: 18px;
            accent-color: var(--brand-gold);
        }

        .spouse-toggle label {
            font-size: 13px;
            font-weight: 600;
            color: var(--brand-navy);
            cursor: pointer;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--brand-white);
            border: 2px solid var(--brand-gold);
            border-radius: 8px;
            padding: 14px 20px;
            box-shadow: 0 8px 32px rgba(0, 32, 91, 0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Social Security & Portfolio Optimizer</h1>
            <p class="subtitle">Optimize claiming strategy with sequence of returns risk analysis</p>
        </header>

        <div class="grid-layout">
            <aside class="sidebar">
                <!-- Client Info -->
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon"></span>Client Information</h2>
                    </div>
                    <div class="card-body">
                        <div class="input-row">
                            <div class="input-group"><label>Current Age</label><input type="number" id="currentAge"
                                    value="62" min="50" max="70" onchange="calculate()"></div>
                            <div class="input-group"><label>Life Expectancy</label><input type="number"
                                    id="lifeExpectancy" value="90" min="70" max="100" onchange="calculate()"></div>
                        </div>
                        <div class="input-group">
                            <label>Full Retirement Age (FRA) Benefit</label>
                            <div class="input-with-prefix"><span class="prefix">$</span><input type="number"
                                    id="fraBenefit" value="3000" step="100" onchange="calculate()"></div>
                            <p class="help-text">Monthly benefit at age 67 (FRA)</p>
                        </div>

                        <div class="spouse-section">
                            <div class="spouse-toggle">
                                <input type="checkbox" id="includeSpouse" onchange="toggleSpouse()">
                                <label for="includeSpouse">Include Spouse</label>
                            </div>
                            <div id="spouseInputs" style="display: none;">
                                <div class="input-row">
                                    <div class="input-group"><label>Spouse Age</label><input type="number"
                                            id="spouseAge" value="60" min="50" max="70" onchange="calculate()"></div>
                                    <div class="input-group"><label>Spouse Life Exp.</label><input type="number"
                                            id="spouseLifeExp" value="92" min="70" max="100" onchange="calculate()">
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label>Spouse FRA Benefit</label>
                                    <div class="input-with-prefix"><span class="prefix">$</span><input type="number"
                                            id="spouseFraBenefit" value="1500" step="100" onchange="calculate()"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Settings -->
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon"></span>Portfolio Settings</h2>
                    </div>
                    <div class="card-body">
                        <div class="input-group">
                            <label>Starting Portfolio Value</label>
                            <div class="input-with-prefix"><span class="prefix">$</span><input type="number"
                                    id="portfolioValue" value="1500000" step="10000" onchange="calculate()"></div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label>Withdrawal Type</label>
                                <select id="withdrawalType" onchange="toggleWithdrawalInput()">
                                    <option value="dollar">Dollar Amount</option>
                                    <option value="percent">Percentage</option>
                                </select>
                            </div>
                            <div class="input-group" id="dollarWithdrawGroup">
                                <label>Annual Withdrawal</label>
                                <div class="input-with-prefix"><span class="prefix">$</span><input type="number"
                                        id="withdrawalDollar" value="60000" step="1000" onchange="calculate()"></div>
                            </div>
                            <div class="input-group" id="percentWithdrawGroup" style="display:none;">
                                <label>Withdrawal Rate</label>
                                <div class="input-with-suffix"><input type="number" id="withdrawalPercent" value="4"
                                        step="0.1" onchange="calculate()"><span class="suffix">%</span></div>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Annual Expense Need (Total)</label>
                            <div class="input-with-prefix"><span class="prefix">$</span><input type="number"
                                    id="annualExpenses" value="80000" step="1000" onchange="calculate()"></div>
                            <p class="help-text">SS + Portfolio withdrawals must cover this</p>
                        </div>
                        <div class="input-group">
                            <label>Inflation Rate</label>
                            <div class="input-with-suffix"><input type="number" id="inflationRate" value="2.5"
                                    step="0.1" onchange="calculate()"><span class="suffix">%</span></div>
                        </div>
                    </div>
                </div>

                <!-- Market Scenarios -->
                <div class="card">
                    <div class="card-header">
                        <h2><span class="icon"></span>Market Scenarios</h2>
                    </div>
                    <div class="card-body">
                        <div class="section-title" style="margin-top:0;">Sequence of Returns Scenarios</div>
                        <div class="checkbox-row"><input type="checkbox" id="scenarioBear" checked
                                onchange="calculate()"><label for="scenarioBear">üêª Bear Market Start (-20%, -15%,
                                -5%...)</label></div>
                        <div class="checkbox-row"><input type="checkbox" id="scenarioLow" checked
                                onchange="calculate()"><label for="scenarioLow">üìâ Low Returns (2-4% annually)</label>
                        </div>
                        <div class="checkbox-row"><input type="checkbox" id="scenarioModerate" checked
                                onchange="calculate()"><label for="scenarioModerate">üìä Moderate Returns (6-7%
                                annually)</label></div>
                        <div class="checkbox-row"><input type="checkbox" id="scenarioHigh" checked
                                onchange="calculate()"><label for="scenarioHigh">üìà Bull Market Start (+15%, +12%,
                                +8%...)</label></div>

                        <div class="section-title">Custom Scenario</div>
                        <div class="input-row">
                            <div class="input-group">
                                <label>Years 1-5 Return</label>
                                <div class="input-with-suffix"><input type="number" id="customReturn1" value="-5"
                                        step="1" onchange="calculate()"><span class="suffix">%</span></div>
                            </div>
                            <div class="input-group">
                                <label>Years 6+ Return</label>
                                <div class="input-with-suffix"><input type="number" id="customReturn2" value="7"
                                        step="1" onchange="calculate()"><span class="suffix">%</span></div>
                            </div>
                        </div>

                        <div class="info-box">
                            <strong>Sequence Risk:</strong> The order of investment returns significantly impacts
                            retirement outcomes. Poor early returns while withdrawing can devastate a portfolio.
                        </div>
                    </div>
                </div>

                <div class="btn-row">
                    <button class="btn primary" onclick="calculate()">Calculate All Scenarios</button>
                </div>
            </aside>

            <main class="main-content">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('overview')">Overview</button>
                    <button class="tab" onclick="showTab('strategies')">Strategy Comparison</button>
                    <button class="tab" onclick="showTab('timeline')">Year-by-Year</button>
                    <button class="tab" onclick="showTab('sensitivity')">Sensitivity Analysis</button>
                </div>

                <div id="overview-tab">
                    <div class="scenario-tabs" id="scenarioTabs"></div>

                    <div class="results-grid" id="summaryResults"></div>

                    <div class="chart-container">
                        <div class="chart-title">Portfolio Value Over Time by SS Claiming Age</div>
                        <div class="chart-wrapper"><canvas id="portfolioChart"></canvas></div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">Total Lifetime Income by Strategy</div>
                        <div class="chart-wrapper"><canvas id="incomeChart"></canvas></div>
                    </div>
                </div>

                <div id="strategies-tab" style="display:none;">
                    <div class="scenario-tabs" id="scenarioTabs2"></div>
                    <div class="strategy-comparison" id="strategyComparison"></div>
                </div>

                <div id="timeline-tab" style="display:none;">
                    <div class="scenario-tabs" id="scenarioTabs3"></div>
                    <div class="card">
                        <div class="card-header">
                            <h2>Year-by-Year Projection</h2>
                            <select id="timelineStrategy" onchange="renderTimeline()"
                                style="padding:6px 10px;border-radius:4px;border:1px solid var(--border);">
                                <option value="62">Claim at 62</option>
                                <option value="65">Claim at 65</option>
                                <option value="67" selected>Claim at 67 (FRA)</option>
                                <option value="70">Claim at 70</option>
                            </select>
                        </div>
                        <div class="card-body" style="overflow-x:auto;">
                            <table class="timeline-table" id="timelineTable"></table>
                        </div>
                    </div>
                </div>

                <div id="sensitivity-tab" style="display:none;">
                    <div class="chart-container">
                        <div class="chart-title">Portfolio Survival by SS Claiming Age & Market Scenario</div>
                        <div class="chart-wrapper"><canvas id="sensitivityChart"></canvas></div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Optimal Claiming Age by Market Condition</div>
                        <div class="chart-wrapper"><canvas id="optimalChart"></canvas></div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <div class="toast" id="toast"><span id="toastMsg"></span></div>
    <script>
        // Constants
        const SS_CLAIMING_AGES = [62, 63, 64, 65, 66, 67, 68, 69, 70];
        const FRA = 67;

        // SS benefit adjustment factors (relative to FRA)
        const SS_FACTORS = {
            62: 0.70, 63: 0.75, 64: 0.80, 65: 0.867, 66: 0.933,
            67: 1.00, 68: 1.08, 69: 1.16, 70: 1.24
        };

        // Market scenario return patterns
        const SCENARIOS = {
            bear: { name: 'Bear Market Start', color: '#ef4444', returns: [-20, -15, -5, 5, 10, 8, 7, 6, 7, 7] },
            low: { name: 'Low Returns', color: '#f59e0b', returns: [2, 3, 2, 4, 3, 2, 4, 3, 3, 4] },
            moderate: { name: 'Moderate Returns', color: '#00205B', returns: [7, 6, 8, 5, 7, 6, 7, 8, 6, 7] },
            high: { name: 'Bull Market Start', color: '#10b981', returns: [15, 12, 10, 8, 5, 6, 7, 6, 7, 6] }
        };

        let currentScenario = 'moderate';
        let calculationResults = {};
        let charts = {};

        const $ = id => document.getElementById(id);
        const $v = id => parseFloat($(id)?.value) || 0;
        const $c = id => $(id)?.checked || false;
        const fC = n => '$' + Math.round(n).toLocaleString();
        const fP = n => (n >= 0 ? '+' : '') + n.toFixed(1) + '%';

        function toggleSpouse() {
            $('spouseInputs').style.display = $c('includeSpouse') ? 'block' : 'none';
            calculate();
        }

        function toggleWithdrawalInput() {
            const type = $('withdrawalType').value;
            $('dollarWithdrawGroup').style.display = type === 'dollar' ? 'block' : 'none';
            $('percentWithdrawGroup').style.display = type === 'percent' ? 'block' : 'none';
            calculate();
        }

        function getSSBenefit(claimAge, fraBenefit) {
            return fraBenefit * SS_FACTORS[claimAge] * 12; // Annual
        }

        function getReturnsForScenario(scenarioKey, years) {
            const pattern = SCENARIOS[scenarioKey].returns;
            const returns = [];
            for (let i = 0; i < years; i++) {
                returns.push(pattern[i % pattern.length] / 100);
            }
            return returns;
        }

        function getCustomReturns(years) {
            const r1 = $v('customReturn1') / 100;
            const r2 = $v('customReturn2') / 100;
            const returns = [];
            for (let i = 0; i < years; i++) {
                returns.push(i < 5 ? r1 : r2);
            }
            return returns;
        }

        function simulateStrategy(params) {
            const { startAge, lifeExp, fraBenefit, spouseAge, spouseFra, spouseLifeExp, includeSpouse,
                portfolio, withdrawal, withdrawalType, expenses, inflation, claimAge, spouseClaimAge, returns } = params;

            const years = lifeExp - startAge;
            const results = [];
            let portfolioValue = portfolio;
            let totalSS = 0;
            let totalWithdrawals = 0;
            let depleted = false;
            let depletedYear = null;

            for (let year = 0; year < years; year++) {
                const age = startAge + year;
                const spouseCurrentAge = includeSpouse ? spouseAge + year : null;

                // Calculate SS income for this year
                let ssIncome = 0;
                if (age >= claimAge) {
                    ssIncome += getSSBenefit(claimAge, fraBenefit);
                }
                if (includeSpouse && spouseCurrentAge >= spouseClaimAge) {
                    ssIncome += getSSBenefit(spouseClaimAge, spouseFra);
                }

                // Adjust expenses for inflation
                const adjustedExpenses = expenses * Math.pow(1 + inflation, year);

                // Calculate needed withdrawal
                const neededFromPortfolio = Math.max(0, adjustedExpenses - ssIncome);

                // Actual withdrawal (limited by portfolio)
                let actualWithdrawal = 0;
                if (!depleted && portfolioValue > 0) {
                    if (withdrawalType === 'percent') {
                        actualWithdrawal = Math.min(portfolioValue, Math.max(neededFromPortfolio, portfolioValue * (withdrawal / 100)));
                    } else {
                        actualWithdrawal = Math.min(portfolioValue, neededFromPortfolio);
                    }
                }

                // Apply market return
                const yearReturn = returns[year] || 0.06;
                const portfolioGrowth = (portfolioValue - actualWithdrawal) * yearReturn;

                portfolioValue = Math.max(0, portfolioValue - actualWithdrawal + portfolioGrowth);

                if (portfolioValue <= 0 && !depleted) {
                    depleted = true;
                    depletedYear = year;
                }

                totalSS += ssIncome;
                totalWithdrawals += actualWithdrawal;

                results.push({
                    year,
                    age,
                    spouseAge: spouseCurrentAge,
                    ssIncome,
                    withdrawal: actualWithdrawal,
                    expenses: adjustedExpenses,
                    portfolioStart: year === 0 ? portfolio : results[year - 1].portfolioEnd,
                    growth: portfolioGrowth,
                    portfolioEnd: portfolioValue,
                    return: yearReturn,
                    shortfall: Math.max(0, adjustedExpenses - ssIncome - actualWithdrawal)
                });
            }

            return {
                claimAge,
                spouseClaimAge,
                years: results,
                finalPortfolio: portfolioValue,
                totalSS,
                totalWithdrawals,
                totalIncome: totalSS + totalWithdrawals,
                depleted,
                depletedYear,
                survivalYears: depleted ? depletedYear : years
            };
        }

        function calculate() {
            const startAge = $v('currentAge');
            const lifeExp = $v('lifeExpectancy');
            const fraBenefit = $v('fraBenefit');
            const includeSpouse = $c('includeSpouse');
            const spouseAge = includeSpouse ? $v('spouseAge') : null;
            const spouseFra = includeSpouse ? $v('spouseFraBenefit') : 0;
            const spouseLifeExp = includeSpouse ? $v('spouseLifeExp') : null;
            const portfolio = $v('portfolioValue');
            const withdrawalType = $('withdrawalType').value;
            const withdrawal = withdrawalType === 'dollar' ? $v('withdrawalDollar') : $v('withdrawalPercent');
            const expenses = $v('annualExpenses');
            const inflation = $v('inflationRate') / 100;

            calculationResults = {};

            // Get enabled scenarios
            const enabledScenarios = [];
            if ($c('scenarioBear')) enabledScenarios.push('bear');
            if ($c('scenarioLow')) enabledScenarios.push('low');
            if ($c('scenarioModerate')) enabledScenarios.push('moderate');
            if ($c('scenarioHigh')) enabledScenarios.push('high');
            enabledScenarios.push('custom');

            const years = lifeExp - startAge;

            // Run simulations for each scenario and claiming age
            enabledScenarios.forEach(scenario => {
                calculationResults[scenario] = {};
                const returns = scenario === 'custom' ? getCustomReturns(years) : getReturnsForScenario(scenario, years);

                SS_CLAIMING_AGES.filter(age => age >= startAge).forEach(claimAge => {
                    // For spouse, test multiple claiming ages or use same as primary
                    const spouseClaimAge = includeSpouse ? Math.max(claimAge, spouseAge >= 62 ? 62 : spouseAge + (62 - spouseAge)) : null;

                    calculationResults[scenario][claimAge] = simulateStrategy({
                        startAge, lifeExp, fraBenefit, spouseAge, spouseFra, spouseLifeExp, includeSpouse,
                        portfolio, withdrawal, withdrawalType, expenses, inflation,
                        claimAge, spouseClaimAge: spouseClaimAge || claimAge, returns
                    });
                });
            });

            renderScenarioTabs();
            renderResults();
        }

        function renderScenarioTabs() {
            const scenarios = Object.keys(calculationResults);
            const html = scenarios.map(s => {
                const info = s === 'custom' ? { name: 'Custom', color: '#8b5cf6' } : SCENARIOS[s];
                const isActive = s === currentScenario;
                return `<button class="scenario-tab ${s} ${isActive ? 'active' : ''}" onclick="selectScenario('${s}')">${info.name}</button>`;
            }).join('');

            ['scenarioTabs', 'scenarioTabs2', 'scenarioTabs3'].forEach(id => {
                if ($(id)) $(id).innerHTML = html;
            });
        }

        function selectScenario(scenario) {
            currentScenario = scenario;
            renderScenarioTabs();
            renderResults();
        }

        function renderResults() {
            if (!calculationResults[currentScenario]) return;

            const results = calculationResults[currentScenario];
            const strategies = Object.values(results);

            // Find best strategy (highest final portfolio or longest survival)
            const best = strategies.reduce((a, b) => {
                if (a.depleted && !b.depleted) return b;
                if (!a.depleted && b.depleted) return a;
                if (a.depleted && b.depleted) return a.survivalYears > b.survivalYears ? a : b;
                return a.finalPortfolio > b.finalPortfolio ? a : b;
            });

            // Summary results
            const fra = results[67] || strategies[0];
            $('summaryResults').innerHTML = `
                <div class="result-card highlight">
                    <div class="result-label">Optimal Claiming Age</div>
                    <div class="result-value">${best.claimAge}</div>
                    <div class="result-sub">Maximizes portfolio longevity</div>
                </div>
                <div class="result-card">
                    <div class="result-label">Best Final Portfolio</div>
                    <div class="result-value">${fC(best.finalPortfolio)}</div>
                    <div class="result-sub">At life expectancy</div>
                </div>
                <div class="result-card">
                    <div class="result-label">FRA (67) Final Portfolio</div>
                    <div class="result-value">${fC(fra.finalPortfolio)}</div>
                    <div class="result-sub">${fra.depleted ? 'Depleted year ' + fra.depletedYear : 'Survives'}</div>
                </div>
                <div class="result-card">
                    <div class="result-label">Total Lifetime SS</div>
                    <div class="result-value">${fC(best.totalSS)}</div>
                    <div class="result-sub">Claiming at ${best.claimAge}</div>
                </div>
                <div class="result-card">
                    <div class="result-label">Total Income</div>
                    <div class="result-value">${fC(best.totalIncome)}</div>
                    <div class="result-sub">SS + Portfolio</div>
                </div>
            `;

            renderPortfolioChart(results);
            renderIncomeChart(results);
            renderStrategyComparison(results, best);
            renderTimeline();
            renderSensitivityCharts();
        }

        function renderPortfolioChart(results) {
            const ctx = $('portfolioChart').getContext('2d');
            if (charts.portfolio) charts.portfolio.destroy();

            const datasets = Object.entries(results).map(([age, data]) => ({
                label: `Claim at ${age}`,
                data: data.years.map(y => ({ x: y.age, y: y.portfolioEnd })),
                borderColor: age == 62 ? '#ef4444' : age == 67 ? '#00205B' : age == 70 ? '#10b981' : '#94a3b8',
                borderWidth: age == 67 ? 3 : 2,
                fill: false,
                tension: 0.3
            }));

            charts.portfolio = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.dataset.label}: ${fC(ctx.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        x: { type: 'linear', title: { display: true, text: 'Age' } },
                        y: { title: { display: true, text: 'Portfolio Value' }, ticks: { callback: v => fC(v) } }
                    }
                }
            });
        }

        function renderIncomeChart(results) {
            const ctx = $('incomeChart').getContext('2d');
            if (charts.income) charts.income.destroy();

            const labels = Object.keys(results);
            const ssData = labels.map(age => results[age].totalSS);
            const withdrawData = labels.map(age => results[age].totalWithdrawals);

            charts.income = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(a => `Age ${a}`),
                    datasets: [
                        { label: 'Social Security', data: ssData, backgroundColor: '#D4AF37' },
                        { label: 'Portfolio Withdrawals', data: withdrawData, backgroundColor: '#00205B' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, ticks: { callback: v => fC(v) } }
                    }
                }
            });
        }

        function renderStrategyComparison(results, best) {
            const ages = [62, 65, 67, 70].filter(a => results[a]);
            $('strategyComparison').innerHTML = ages.map(age => {
                const r = results[age];
                const isBest = r.claimAge === best.claimAge;
                return `
                    <div class="strategy-card ${isBest ? 'best' : ''}">
                        <div class="strategy-header">
                            <span class="strategy-name">Claim at Age ${age}</span>
                            ${isBest ? '<span class="strategy-badge">Optimal</span>' : ''}
                        </div>
                        <div class="strategy-body">
                            <div class="strategy-row"><span class="label">Monthly SS Benefit</span><span class="value">${fC(getSSBenefit(age, $v('fraBenefit')) / 12)}</span></div>
                            <div class="strategy-row"><span class="label">Annual SS Income</span><span class="value">${fC(getSSBenefit(age, $v('fraBenefit')))}</span></div>
                            <div class="strategy-row"><span class="label">Total Lifetime SS</span><span class="value">${fC(r.totalSS)}</span></div>
                            <div class="strategy-row"><span class="label">Final Portfolio</span><span class="value ${r.finalPortfolio > 0 ? 'positive' : 'negative'}">${fC(r.finalPortfolio)}</span></div>
                            <div class="strategy-row"><span class="label">Portfolio Survives?</span><span class="value ${r.depleted ? 'negative' : 'positive'}">${r.depleted ? 'No (Year ' + r.depletedYear + ')' : 'Yes'}</span></div>
                            <div class="strategy-row"><span class="label">Total Income</span><span class="value">${fC(r.totalIncome)}</span></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderTimeline() {
            const claimAge = parseInt($('timelineStrategy').value);
            if (!calculationResults[currentScenario] || !calculationResults[currentScenario][claimAge]) return;

            const data = calculationResults[currentScenario][claimAge];
            const includeSpouse = $c('includeSpouse');

            let html = `<thead><tr>
                <th>Year</th><th>Age</th>${includeSpouse ? '<th>Spouse</th>' : ''}
                <th class="number">SS Income</th><th class="number">Withdrawal</th>
                <th class="number">Expenses</th><th class="number">Return</th>
                <th class="number">Portfolio</th><th class="number">Shortfall</th>
            </tr></thead><tbody>`;

            data.years.forEach(y => {
                html += `<tr>
                    <td>${y.year + 1}</td>
                    <td>${y.age}</td>
                    ${includeSpouse ? `<td>${y.spouseAge || '-'}</td>` : ''}
                    <td class="number">${fC(y.ssIncome)}</td>
                    <td class="number">${fC(y.withdrawal)}</td>
                    <td class="number">${fC(y.expenses)}</td>
                    <td class="number ${y.return >= 0 ? 'positive' : 'negative'}">${fP(y.return * 100)}</td>
                    <td class="number ${y.portfolioEnd > 0 ? '' : 'negative'}">${fC(y.portfolioEnd)}</td>
                    <td class="number ${y.shortfall > 0 ? 'negative' : ''}">${y.shortfall > 0 ? fC(y.shortfall) : '-'}</td>
                </tr>`;
            });

            html += '</tbody>';
            $('timelineTable').innerHTML = html;
        }

        function renderSensitivityCharts() {
            // Survival chart
            const ctx1 = $('sensitivityChart').getContext('2d');
            if (charts.sensitivity) charts.sensitivity.destroy();

            const scenarios = Object.keys(calculationResults);
            const ages = [62, 65, 67, 70];

            const datasets = scenarios.map(s => {
                const info = s === 'custom' ? { name: 'Custom', color: '#8b5cf6' } : SCENARIOS[s];
                return {
                    label: info.name,
                    data: ages.map(age => calculationResults[s][age]?.survivalYears || 0),
                    backgroundColor: info.color
                };
            });

            charts.sensitivity = new Chart(ctx1, {
                type: 'bar',
                data: { labels: ages.map(a => `Age ${a}`), datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { title: { display: true, text: 'Years Portfolio Survives' } } }
                }
            });

            // Optimal chart
            const ctx2 = $('optimalChart').getContext('2d');
            if (charts.optimal) charts.optimal.destroy();

            const optimalData = scenarios.map(s => {
                const results = calculationResults[s];
                const best = Object.values(results).reduce((a, b) =>
                    a.finalPortfolio > b.finalPortfolio ? a : b
                );
                return best.claimAge;
            });

            charts.optimal = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: scenarios.map(s => s === 'custom' ? 'Custom' : SCENARIOS[s].name),
                    datasets: [{
                        label: 'Optimal Claiming Age',
                        data: optimalData,
                        backgroundColor: scenarios.map(s => s === 'custom' ? '#8b5cf6' : SCENARIOS[s].color)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { min: 60, max: 72, title: { display: true, text: 'Optimal Claiming Age' } } }
                }
            });
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            ['overview', 'strategies', 'timeline', 'sensitivity'].forEach(t => {
                $(t + '-tab').style.display = t === tabName ? 'block' : 'none';
            });
        }

        // Initialize
        calculate();

        // Profile Sync with GlobalStateManager
        function loadFromProfile() {
            if (typeof GlobalStateManager === 'undefined') return;
            const state = GlobalStateManager.getState();

            // Map profile fields to form inputs
            if (state.client1?.age) $('currentAge').value = state.client1.age;
            if (state.client2?.age) $('spouseAge').value = state.client2.age;
            if (state.socialSecurity?.client1FRA) $('fraBenefit').value = state.socialSecurity.client1FRA;
            if (state.socialSecurity?.client2FRA) $('spouseFraBenefit').value = state.socialSecurity.client2FRA;

            // Calculate total portfolio from all account types
            const portfolio = (state.portfolio?.preTax || 0) +
                (state.portfolio?.roth || 0) +
                (state.portfolio?.taxable || 0);
            if (portfolio > 0) $('portfolioValue').value = portfolio;

            // Auto-enable spouse if client2 data exists
            if (state.client2?.age || state.client2?.name) {
                $('includeSpouse').checked = true;
                toggleSpouse();
            }
        }

        // Initialize GlobalStateManager and load profile
        if (typeof GlobalStateManager !== 'undefined') {
            GlobalStateManager.init();
            loadFromProfile();

            // Subscribe to profile updates
            GlobalStateManager.subscribe(function (state) {
                loadFromProfile();
                calculate();
            });
        }
    </script>
</body>

</html>